---
title: "¿Se vive bien en la Comunidad Valenciana?"
author: "Lawrence Daniel Phillips Bates (ladap@alumni.uv.es)  \n\n Pedro Julián López Mejías (pejulome@alumni.uv.es)  \n \n Julio Gonzalez Miralles(jugonmi@alumni.uv.es). \n\n Universitat de València"
date: "Diciembre de 2021 (actualizado el `r format(Sys.time(), '%d-%m-%Y')`)"
output:
  html_document:
    #css: "./assets/my_css_file.css"
    theme: united
    highlight: textmate 
    toc: true
    toc_depth: 3 
    toc_float: 
      collapsed: true
      smooth_scroll: true
    self_contained: true
    number_sections: false
    df_print: kable
    code_download: true
editor_options: 
  chunk_output_type: console
---

```{r packages-setup, include = FALSE}
#INSTALAMOS LIBRERÍAS
library(tidyverse)
library(klippy)   
library(knitr)
library(data.table)
library(gt)
library(ggthemes)
library(gganimate)
library(transformr)
library(ggpubr)
library(ggplot2)
library(dplyr)
library(hrbrthemes)
library(paletteer)
library(kableExtra)
library(plotly)
library(extrafont) 

```

```{r chunk-setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = TRUE, message = FALSE, warning = FALSE, 
                      #results = "hold",
                      cache = FALSE, cache.path = "/caches/", comment = "#>",
                      #fig.width = 7, #fig.height= 7,   
                      #out.width = 7, out.height = 7,
                      collapse = TRUE,  fig.show = "hold",
                      fig.asp = 0.628, out.width = "75%", fig.align = "center")
knitr::opts_chunk$set(dev = "png", dev.args = list(type = "cairo-png"))
```

```{r options-setup, include = FALSE}
options(scipen = 999) #- para quitar la notación científica
options("yaml.eval.expr" = TRUE) 
```


```{r klippy, echo = FALSE}
klippy::klippy(position = c("top", "right")) #- remotes::install_github("rlesur/klippy")
```


```{r limpieza datos, include = FALSE}

#CARGAMOS LOS DATOS

Renta_media <- rio::import(here::here("./datos/Renta_media.csv"))
Renta_media_UE <- rio::import(here::here("./datos/Renta_media_UE.csv"))

Renta_mediana <- rio::import(here::here("./datos/Renta_mediana.csv"))
Renta_mediana_UE <- rio::import(here::here("./datos/Renta_mediana_UE.csv"))

Desigualdad <- rio::import(here::here("./datos/Desigualdad.csv"))
Desigualdad_UE <- rio::import(here::here("./datos/Desigualdad_UE.csv"))                    
R_pobreza <- rio::import(here::here("./datos/Riesgo_pobreza.csv"))
R_pobreza_UE <- rio::import(here::here("./datos/Riesgo_pobreza_UE.csv"))

tasa_empleo <- rio::import(here::here("./datos/tasa_empleo.csv"))
df_tasa_empleo <- tasa_empleo

tasa_paro <- rio::import(here::here("./datos/tasa_paro.csv"))
df_tasa_paro <- tasa_paro

satis_trab <- rio::import(here::here("./datos/satisfaccion.csv"))
df_satis_trab <- satis_trab

trabajo_temp <- rio::import(here::here("./datos/trabajo_temporal.csv"))
df_trabajo_temp <- trabajo_temp

abandono <- rio::import(here::here("datos/abandono_ccaa.csv"))

esperanza_vida <- rio::import(here::here("datos/esperanza_vida.csv")) 

no_acceso_1 <- rio::import(here::here("datos/no_acceso_1.csv")) 

ruidos <- rio::import(here::here("./datos/ruidos.csv"))
df_ruidos <- ruidos

df_del_ccaa <- rio::import(here::here("datos/del_ccaa.csv")) 

vida_hm <- rio::import(here::here("datos/vida_hm.csv"))

no_acceso_1 <- rio::import(here::here("datos/no_acceso_1.csv"))

no_acceso_2 <- rio::import(here::here("datos/no_acceso_2.csv"))

educ_02 <- rio::import(here::here("datos/educ_02.csv"))

educ_38 <- rio::import(here::here("datos/educ_38.csv"))

delincuencia <- rio::import(here::here("datos/del_ccaa_julio.csv"))

abandono <- rio::import(here::here("datos/abandono_ccaa.csv"))

#Lawrence, mirar csvs y copiar los originales en arhcivo datos
df_no_acceso_1 <- rio::import(here::here("./datos/no_acceso_1_lawrence.csv")) 

df_abandono <- rio::import(here::here("datos/abandono_ccaa_lawrence.csv"))

df_educ_38 <- rio::import(here::here("datos/educ_38_lawrence.csv")) 

df_esperanza_vida <- rio::import(here::here("datos/esperanza_vida_lawrence.csv"))

df_ruidos <- rio::import(here::here("./datos/ruidos.csv"))

df_del_ccaa <- rio::import(here::here("datos/del_ccaa_lawrence.csv")) 

```


<hr class="linea-black">

<!-- El párrafo de abajo has de dejarlo casi igual, solo HAS de SUSTITUIR "perezp44" por tu usuario de Github-->
Trabajo elaborado para la asignatura "Programación y manejo de datos en la era del Big Data" de la Universitat de València durante el curso 2021-2022. El repo del trabajo está [aquí](https://github.com/lorenzo1999/trabajo_BigData_equipo){target="_blank"}. 

<!-- El párrafo de abajo has de dejarlo exactamente igual, NO has de cambiar nada-->

La página web de la asignatura y los trabajos de mis compañeros pueden verse [aquí](https://perezp44.github.io/intro-ds-21-22-web/07-trabajos.html){target="_blank"}.

<hr class="linea-red">


# 1.1 Introducción

El objetivo principal del trabajo es analizar a través de una serie de indicadores la calidad de vida en nuestra comunidad para conoocer nuestra posición con respecto al resto de comunidades españolas.En ciertos aspectos analizaremos un ámbito de mayor nivel, es decir, analizaremos la posición de España en comparación con la UE para ver como esto se refleja en la calidad de vida de la Comunidad Valenciana.





# 1.2 Datos
Los datos los obtendremos a partir del Instituto Nacional de Estadística, en concreto, analizaremos indicadores de calidad de vida para conocer el progreso de la sociedad y el bienestar de los individuos más cercanos de nuestro de entorno como son las condiciones económicas, trabajo, educación, desigualdad, salud, etc.




## 1.3 Procesando los datos
Extraeremos los datos de Excel, seleccionaremos las variables que consideramos más importantes para determinar lo que es calidad de vida y posiblemente tendremos que juntar o fusionar tablas con el objetivo de comparar con respecto a la UE.


<br>



# 1.4 Bibliografía

<br>

Hemos utilizado datos del INE.

<br>




```{r, echo = FALSE}
sessioninfo::session_info() %>% details::details(summary = 'Información de mi R-sesión:') 
```


<br><br>

<div class="tocify-extend-page" data-unique="tocify-extend-page" style="height: 0;"></div>


```{r codigo_universal, eval= TRUE, echo= FALSE, warning= FALSE, comment = FALSE}

#CODIGO UNIVERSAL--------------
#Crear vector de las Comunidades Autónomas-----
CCAA <- c("Andalucia", "Aragon", "Asturias",  "Baleares", "Canarias", "Cantabria", "Castilla_La_Mancha", "Castilla_y_Leon", "Catalunya", "Ceuta", "Comunidad_Valenciana", "Extremadura", "Galicia", "Madrid", "Melilla", "Murcia", "Navarra", "Pais_Vasco", "La_Rioja", "España", "UE_27", "UE_28")

#para que sea misma longitud (sin UE27, UE28 y España) ya que en la creación del ranking vamos a utilizar CCAA solo
CCAA_sin_UE <- c("Andalucia", "Aragon", "Asturias",  "Baleares", "Canarias", "Cantabria", "Castilla_La_Mancha", "Castilla_y_Leon", "Catalunya", "Ceuta", "Comunidad_Valenciana", "Extremadura", "Galicia", "Madrid", "Melilla", "Murcia", "Navarra", "Pais_Vasco", "La_Rioja")

#CCAA pero ordenado para datos julio y Pedro (trabajo, educ_salud)
CCAA_sin_UE_sin_ord <- c("Andalucia", "Aragon", "Asturias",  "Baleares", "Canarias", "Cantabria", "Castilla_y_Leon", "Castilla_La_Mancha", "Catalunya", "Comunidad_Valenciana", "Extremadura", "Galicia", "Madrid", "Murcia", "Navarra", "Pais_Vasco", "La_Rioja","Ceuta", "Melilla")

#CCAA para "ruidos", 
CCAA_2 <- c("Ceuta", "Murcia", "Canarias", "Melilla", "Madrid", "Comunidad_Valenciana", "Andalucia", "Baleares", "Navarra", "La_Rioja", "Pais_Vasco", "Catalunya", "Asturias", "Aragon", "Cantabria", "Galicia", "Castilla_y_Leon", "Castilla_La_Mancha", "Extremadura")
#CCAA para columna de Total norm ef amb
CCAA_3 <- c("Cantabria", "Extremadura", "Castilla_y_Leon", "Galicia", "Castilla_La_Mancha", "Asturias", "La_Rioja", "Aragon", "Navarra", "Baleares", "Pais_Vasco", "Comunidad_Valenciana", "Catalunya", "Andalucia", "Madrid", "Canarias", "Murcia", "Ceuta", "Melilla")
#CCAA para ranking final
CCAA_rank_final <- c("Pais_Vasco", "Navarra", "Madrid", "Catalunya", "Baleares", "La_Rioja", "Aragon", "Castilla_y_Leon", "Cantabria", "Galicia", "Asturias", "Castilla_La_Mancha", "Comunidad_Valenciana", "Murcia", "Andalucia", "Canarias", "Extremadura", "Melilla", "Ceuta")
#funcion para normalizar numeros, cuanto mas grande mejor
min_max_norm_gran <- function(x) {
  (x - min(x)) / (max(x) - min(x))
}

#funcion para normalizar numeros, cuanto mas pequeño mejor
min_max_norm_peq <- function(x) {
  1 - ((x - min(x)) / (max(x) - min(x)))
}
```



# 2. CONDICIONES MATERIALES

<br>

Las condiciones materiales y/o económicas de los ciudadanos son uno de los principales factores del nivel de vida y uno de los indicadores más importantes a la hora de comparar la riqueza entre dos regiones o países. Aunque no nos guste, el dinero mueve el mundo y por tanto es esencial incluir este aspecto en nuestro análisis del nivel de vida en la Comunidad Valenciana. A continuación, os presentaremos cuatro indicadores que hemos considerados prioritarios con el fin de contrastar el nivel de las condiciones materiales en las distintas Comunidades Autónomas, haciendo hincapié en nuestra Comunidad.

<br><br>

## 2.1 RENTA MEDIA

<br>

En nuestros datos, la renta media representa la renta disponible neta anual de cada hogar en base a la Encuesta de condiciones de Vida. Es el indicador que nos viene de primeras a la cabeza cuando pensamos en realizar una comparación del nivel de vida entre dos regiones distintas. Por lo general, cuanto más elevada sea la renta media mayor será la renta individual de cada hogar y por tanto de cada ciudadano.
 El único inconveniente de utilizar la renta media es el gran peso que tienen los “outliers” (valores atípicos) que podrían distorsionar nuestros resultados. Por ejemplo, una renta media de un multimillonario nos elevaría la renta media promedio, pero sin llegar a aumentar realmente la renta de los demás ciudadanos. Esto es un problema que se puede corregir empleando, además de valores medios, los valores medianos (cosa que veremos en el siguiente apartado).
A continuación, os mostramos una tabla resaltando los valores de la renta media en 2020 con las tres CCAA con menor renta media y las tres con mayor renta media, sin olvidarnos de la comunidad Valenciana y en este caso la UE-27.  
Observamos que no tenemos datos de la UE para este año, pero podemos asumir que el valor sería aproximado al 2019. La tabla está ordenada de mayor a menor, siendo País Vasco la región “número 1”, cosa que se repetirá durante mucho de nuestro trabajo.

<br>
```{r renta media, eval= TRUE, echo= FALSE, warning= FALSE, comment = FALSE}
#Renta media
transpuesto_media <- dcast(melt(Renta_media, id.vars = "V1"), variable ~ V1)
transpuesto_UE_media <- dcast(melt(Renta_media_UE, id.vars = "V1"), variable ~ V1)

transpuesto_UE_media$Media <- NULL
transpuesto_media$Media <- NULL

transpuesto_UE_media$Var.2 <- as.numeric(transpuesto_UE_media$Var.2) 

UE_ESP_media <- inner_join(transpuesto_media, transpuesto_UE_media, by = "Var.2")
transpuesto_UE_media <- dcast(melt(UE_ESP_media, id.vars = "Var.2"), variable ~ Var.2)

#eliminar columnas "variable" "total2 (estaba repetida), "variable"
transpuesto_UE_media <- transpuesto_UE_media[-c(1, 22, 23),]

#quitar fila de "variable"
transpuesto_UE_media$variable <- NULL
#añadir vector de CCAA al data frame transpuesto_UE
transpuesto_UE_media$CCAA <- CCAA
#reordenar para poner columna de CCAA primero
transpuesto_UE_media <- transpuesto_UE_media  %>% select("CCAA", everything())

#filtrar solo valencia, España y UE
df_CV_ESP_UE_media <- transpuesto_UE_media %>% filter(CCAA %in% c("Comunidad_Valenciana", "España", "UE_27", "UE_28"))

df_Renta_media <- transpuesto_UE_media %>% filter(!CCAA %in% c("UE_28", "UE_27", "España"))

#Gráfico renta media-----
df_Renta_media_graph <- transpuesto_UE_media %>% pivot_longer(., !CCAA, values_to = "Renta_media", names_to = "Year")
view(df_Renta_media_graph)
df_Renta_media_graph$Renta_media <- as.numeric(df_Renta_media_graph$Renta_media)

transpuesto_UE_media_ord <- transpuesto_UE_media %>% arrange(desc(`2020`))
transpuesto_UE_media_ord$`2020` <- as.numeric(transpuesto_UE_media_ord$`2020`)

p_renta_media <- transpuesto_UE_media_ord %>% select(-c(`2008`,`2009`, `2010`, `2011`, `2012`, `2013`, `2014`))  %>% 
  filter(CCAA %in% c("Navarra", "Pais_Vasco", "Madrid", "Extremadura", "Murcia", "Andalucia", "Comunidad_Valenciana", "UE_27")) %>% gt() %>%
  cols_label(CCAA = "Comunidad Autónoma") %>% tab_header(title = md("Comparación de la Renta media de la CV con otras CCAA y la UE-27")) %>%
  tab_source_note(source_note = "Datos recogidos del INE, expresados en € y el año 2013 como base.") %>%
  tab_style(
    locations = cells_column_labels(columns = everything()),
            style = list(
              cell_borders(sides = "bottom", weight = px(3)),
              cell_text(weight = "bold"))
  ) %>% tab_style(
    locations = cells_title(groups = "title"),
    style     = list(
      cell_text(weight = "bold", size = 24)
    )
  ) %>%
  data_color(
    columns = `2020`,
    colors = scales::col_numeric (
      palette = c(
        "red", "orange", "green", "blue"),
      domain = c(13000, 23500))
  )

p_renta_media
```

<br><br>

## 2.2 RENTA MEDIANA

<br>

Como hemos dicho antes, los valores atípicos pueden distorsionar la media de las variables y por tanto es recomendado tomar en cuenta los valores medianos. En este caso, no afecta al resultado final y por tanto podemos asumir que no existen muchos “outliers”. 

En este gráfico se representa la evolución de la renta mediana desde 2008 hasta 2020 en las mismas regiones que en el apartado anterior de la renta media. Pero al estar en formato de gráfico, podemos observar la serie temporal y vemos de una manera más rápida y fácil la tendencia de los valores. En este caso, podemos ver el fuerte impacto negativo de la crisis económica de la Gran recesión de 2008 y el decrecimiento de la renta mediana en todas las CCAA (pero no en la UE) hasta aproximadamente en año 2015 en donde la tendencia se vuelve creciente hasta llegar a superar los niveles precrisis en los últimos dos años. 
Podemos intuir que, en las cifras de 2021, que habrá una tendencia negativa debido a la crisis sanitaria de la COVID-19 y sus grandes impactos negativos. 

<br>
```{r renta mediana, eval= TRUE, echo= FALSE, warning= FALSE, comment = FALSE}

#Renta mediana
transpuesto_mediana <- dcast(melt(Renta_mediana, id.vars = "V1"), variable ~ V1)
transpuesto_UE_mediana <- dcast(melt(Renta_mediana_UE, id.vars = "V1"), variable ~ V1)

transpuesto_UE_mediana$Mediana <- NULL
transpuesto_mediana$Mediana <- NULL

transpuesto_UE_mediana$Var.2 <- as.numeric(transpuesto_UE_mediana$Var.2)

UE_ESP_mediana <- inner_join(transpuesto_mediana, transpuesto_UE_mediana, by = "Var.2")

transpuesto_UE_mediana <- dcast(melt(UE_ESP_mediana, id.vars = "Var.2"), variable ~ Var.2)

#elimirar columnas "variable" "total2 (estaba repetida), "variable"
transpuesto_UE_mediana <- transpuesto_UE_mediana[-c(1, 22, 23),]

#quitar fila de "variable"
transpuesto_UE_mediana$variable <- NULL
#añadir vector de CCAA al data frame transpuesto_UE
transpuesto_UE_mediana$CCAA <- CCAA
#reordenar para poner columna de CCAA primero
transpuesto_UE_mediana <- transpuesto_UE_mediana  %>% select("CCAA", everything())

#filtrar solo valencia, España y UE
df_CV_ESP_UE_mediana <- transpuesto_UE_mediana %>% filter(CCAA %in% c("Comunidad_Valenciana", "España", "UE_27", "UE_28"))

df_Renta_mediana <- transpuesto_UE_mediana %>% filter(!CCAA %in% c("UE_28", "UE_27", "España"))

#Gráfico renta mediana------
df_Renta_mediana_graph <- transpuesto_UE_mediana %>% pivot_longer(., !CCAA, values_to = "Renta_mediana", names_to = "Year")
view(df_Renta_mediana_graph)
df_Renta_mediana_graph$Renta_mediana <- as.numeric(df_Renta_mediana_graph$Renta_mediana)

df_Renta_mediana_graph$Year <- as.numeric(df_Renta_mediana_graph$Year)

p_renta_mediana <- df_Renta_mediana_graph %>% filter( CCAA %in% c("Navarra", "Pais_Vasco", "Madrid", "Extremadura", "Murcia", "Andalucia", "Comunidad_Valenciana", "UE_27")) %>% 
  ggplot(., aes(x = Year, y = Renta_mediana, group = CCAA, color = CCAA)) + geom_point() + geom_line()  +
  scale_y_continuous(limits = c(9000, 22000), breaks = seq(0, 25000, by = 2500)) +
  labs(x = NULL, y = "Renta mediana (€)",
       title = "Comparación de la Renta mediana de la CV con otras CCAA y la UE-27",
       subtitle = "Vemos un claro efecto de la Gran Recesión y su posterior recuperación",
       caption = "Datos recogidos del INE. Año base 2013") + 
  theme(axis.title.x = element_text(margin = margin(t = 10), size = 15),
        axis.title.y = element_text(margin = margin(r = 10), size = 15)) +
  theme_stata()
  
p_renta_mediana


```
<br><br>

## 2.3 Desigualdad

<br>

La desigualdad es un aspecto de la economía que últimamente está teniendo un gran peso en las decisiones político-económicas a nivel mundial. Dado que, en los últimos 30 años, las diferencias del nivel de renta entre los más ricos y más pobres se están exacerbando tanto entre distintos continentes y países como en un mismo país. Es por esto, que decidimos incluir este indicador en nuestro estudio
Concretamente, el indicador de desigualdad que analiza el “INE” se mide de la siguiente manera: la relación entre la renta media del 20% de la población con la renta más alto y la renta media del 20% de la población con la renta más baja, tomando como año base el 2013.
Analizando el gráfico, extrapolamos el hecho de que en muchas CCAA la relación se ha mantenido constante, incluyendo en la Comunidad Valenciana. Como excepción, encontramos Melilla y Ceuta (con una gran oscilación y un gran crecimiento últimamente de la desigualdad en Melilla) y Asturias, que ha sufrido un repunte en 2019 y 2020.

<br>
```{r desigualadad, eval= TRUE, echo= FALSE, warning= FALSE, comment = FALSE}

#DESIGUALDAD

transpuesto_desigualdad <- dcast(melt(Desigualdad, id.vars = "V1"), variable ~ V1)
transpuesto_desigualdad_UE <- dcast(melt(Desigualdad_UE, id.vars = "V1"), variable ~ V1)

transpuesto_desigualdad_UE$Var.2 <- as.numeric(transpuesto_desigualdad_UE$Var.2) 
transpuesto_desigualdad$Var.2 <- as.numeric(transpuesto_desigualdad$Var.2) 

UE_ESP_desigualdad <- inner_join(transpuesto_desigualdad, transpuesto_desigualdad_UE, by = "Var.2")

transpuesto_desigualdad_UE <- dcast(melt(UE_ESP_desigualdad, id.vars = "Var.2"), variable ~ Var.2)

#elimirar columnas "variable" "total2 (estaba repetida), "variable"
transpuesto_desigualdad_UE <- transpuesto_desigualdad_UE[-c(1, 22, 23,24),]

#quitar fila de "variable"
transpuesto_desigualdad_UE$variable <- NULL
#añadir vector de CCAA al data frame transpuesto_UE
transpuesto_desigualdad_UE$CCAA <- CCAA
#reordenar para poner columna de CCAA primero
transpuesto_desigualdad_UE <- transpuesto_desigualdad_UE  %>% select("CCAA", everything())

#filtrar solo valencia, España y UE
df_CV_ESP_UE_desigualdad <- transpuesto_desigualdad_UE %>% filter(CCAA %in% c("Comunidad_Valenciana", "España", "UE_27", "UE_28"))

df_Desigualdad <- transpuesto_desigualdad_UE %>% filter(!CCAA %in% c("UE_28", "UE_27", "España"))

#Gráfico Desigualdad-----
#cambiar todas comas a puntos en una línea
df_Desigualdad_sin_CCAA <- df_Desigualdad[-1]
df_Desigualdad_sin_CCAA <- data.frame(lapply(df_Desigualdad_sin_CCAA, function(x) gsub(",", ".", x, fixed = TRUE)))
df_Desigualdad_sin_CCAA <- as.data.frame(sapply(df_Desigualdad_sin_CCAA, as.numeric))

df_Desigualdad_sin_CCAA$CCAA <- CCAA_sin_UE
df_Desigualdad_sin_CCAA <- df_Desigualdad_sin_CCAA  %>% select(CCAA, everything())
df_Desigualdad <- df_Desigualdad_sin_CCAA

df_Desiguladad_graph <- transpuesto_desigualdad_UE %>% pivot_longer(., !CCAA, values_to = "Desigualdad", names_to = "Year")

df_Desiguladad_graph$Desigualdad <- as.numeric(gsub(",", ".", gsub("\\.", "", df_Desiguladad_graph$Desigualdad)))
df_Desiguladad_graph$Year <- as.numeric(df_Desiguladad_graph$Year)

p_desigualdad <- df_Desiguladad_graph %>% filter(!CCAA == "UE_27", CCAA %in% c("Melilla", "Ceuta", "Asturias", "castilla_y_Leon", "Extremadura", "Navarra", "Comunidad_Valenciana")) %>% 
  ggplot( aes(x = Year, y = Desigualdad, group = CCAA, color = CCAA)) + geom_point() + geom_line()  +
  scale_y_continuous(limits = c(2, 16), breaks = seq(0, 20, by = 2)) +
  scale_x_continuous(limits = c(2008, 2020), breaks = seq(2008, 2020, by = 5))  + facet_wrap(~ CCAA) +
  labs(x = NULL, y = "Ratio de desigualdad",
       title = "Comparación de la Desigualdad de la CV con otras CCAA",
       subtitle = "Relación entre la renta media del quintil más alto con respecto al quintil más bajo",
       caption = "Datos recogidos del INE. Año base 2013") + 
  theme(axis.title.x = element_text(margin = margin(t = 10), size = 15),
        axis.title.y = element_text(margin = margin(r = 10), size = 15)) +
  theme_stata()

p_desigualdad

```

<br><br>

## 2.4 Riesgo de pobreza

<br>

Otro indicador que se usa para medir la situación económica de los ciudadanos es el umbral de riesgo de pobreza. El umbral de riesgo de pobreza se define como: el porcentaje de personas cuyos ingresos anuales por unidad de consumo recibidos en el año anterior al que se realiza la encuesta, están por debajo del umbral de riesgo de pobreza (fijado en el 60% de la mediana de los ingresos por unidad de consumo de todos los hogares a nivel nacional)
Por tanto, cuanto menor es el porcentaje menor riesgo de pobreza en cada CCAA. Hemos representado los datos en formato de tabla con el fin de analizar el nivel de los últimos años y su evolución con una perspectiva más reciente. 

Lo primero que nos llama la atención es que nuestra Comunidad presenta un elevado nivel de riesgo de pobreza. ¡Casi uno de cada cuatro unidades de consumo está en situación de riesgo de pobreza! Aún peor la situación de Extremadura, con casi uno de cada tres. En el otro extremo, se encuentran Navarra y el País Vasco, y algo peor se encuentran las Islas Baleares.

<br>
```{r riesgo pobreza, eval= TRUE, echo= FALSE, warning= FALSE, comment = FALSE}

#Riesgo pobreza

transpuesto_R_pobreza <- dcast(melt(R_pobreza, id.vars = "V1"), variable ~ V1)
transpuesto_R_pobreza_UE <- dcast(melt(R_pobreza_UE, id.vars = "V1"), variable ~ V1)

transpuesto_R_pobreza_UE$Var.2 <- as.numeric(transpuesto_R_pobreza_UE$Var.2) 
transpuesto_R_pobreza$Var.2 <- as.numeric(transpuesto_R_pobreza$Var.2) 

UE_ESP_R_pobreza <- inner_join(transpuesto_R_pobreza, transpuesto_R_pobreza_UE, by = "Var.2")
transpuesto_R_pobreza_UE <- dcast(melt(UE_ESP_R_pobreza, id.vars = "Var.2"), variable ~ Var.2)

#elimirar columnas "variable" "total2 (estaba repetida), "variable"
transpuesto_R_pobreza_UE <- transpuesto_R_pobreza_UE[-c(1, 22, 23),]

#quitar fila de "variable"
transpuesto_R_pobreza_UE$variable <- NULL
#añadir vector de CCAA al data frame transpuesto_UE
transpuesto_R_pobreza_UE$CCAA <- CCAA
#reordenar para poner columna de CCAA primero
transpuesto_R_pobreza_UE <- transpuesto_R_pobreza_UE  %>% select("CCAA", everything())

#filtrar solo valencia, España y UE
df_CV_ESP_UE_R_pobreza <- transpuesto_R_pobreza_UE %>% filter(CCAA %in% c("Comunidad_Valenciana", "España", "UE_27", "UE_28"))

df_Riesgo_pobreza <- transpuesto_R_pobreza_UE %>% filter(!CCAA %in% c("UE_28", "UE_27", "España"))

#Gráfico Riesgo Pobreza-----


df_Riesgo_pobreza_sin_CCAA <- df_Riesgo_pobreza[-1]
df_Riesgo_pobreza_sin_CCAA <- data.frame(lapply(df_Riesgo_pobreza_sin_CCAA, function(x) gsub(",", ".", x, fixed = TRUE)))
df_Riesgo_pobreza_sin_CCAA <- as.data.frame(sapply(df_Riesgo_pobreza_sin_CCAA, as.numeric))

df_Riesgo_pobreza_sin_CCAA$CCAA <- CCAA_sin_UE
df_Riesgo_pobreza_sin_CCAA <- df_Riesgo_pobreza_sin_CCAA  %>% select(CCAA, everything())
df_Riesgo_pobreza <- df_Riesgo_pobreza_sin_CCAA

df_Riesgo_pobreza_graph<- transpuesto_R_pobreza_UE %>% pivot_longer(., !CCAA, values_to = "Riesgo_pobreza", names_to = "Year")

df_Riesgo_pobreza_graph$Riesgo_pobreza <- as.numeric(gsub(",", ".", gsub("\\.", "", df_Riesgo_pobreza_graph$Riesgo_pobreza)))
#p4 <- df_Riesgo_pobreza_graph %>% filter(!CCAA == "UE_27", CCAA %in% c("Melilla", "Ceuta", "Extremadura", "Navarra", "Pais_Vasco", "Baleares", "Comunidad_Valenciana")) %>% 
 # ggplot(., aes(x = Year, y = Riesgo_pobreza, group = CCAA, color = CCAA)) + geom_point() + geom_line()  + scale_y_continuous(limits = c(0, 50), breaks = seq(0, 50, by = 5))
#p4
#eliminar x de todas las columnas
colnames (df_Riesgo_pobreza) <- gsub("X", "", colnames(df_Riesgo_pobreza))
#cambiar comas a puntos (se ve mejor en la tabla)
transpuesto_R_pobreza_UE$`2020` <- as.numeric(gsub(",", ".", gsub("\\.", "", transpuesto_R_pobreza_UE$`2020`)))
transpuesto_R_pobreza_UE$`2019` <- as.numeric(gsub(",", ".", gsub("\\.", "", transpuesto_R_pobreza_UE$`2019`)))
transpuesto_R_pobreza_UE$`2018` <- as.numeric(gsub(",", ".", gsub("\\.", "", transpuesto_R_pobreza_UE$`2018`)))
transpuesto_R_pobreza_UE$`2017` <- as.numeric(gsub(",", ".", gsub("\\.", "", transpuesto_R_pobreza_UE$`2017`)))
transpuesto_R_pobreza_UE$`2016` <- as.numeric(gsub(",", ".", gsub("\\.", "", transpuesto_R_pobreza_UE$`2016`)))
transpuesto_R_pobreza_UE$`2015` <- as.numeric(gsub(",", ".", gsub("\\.", "", transpuesto_R_pobreza_UE$`2015`)))
  
transpuesto_R_pobreza_UE_ord <- transpuesto_R_pobreza_UE %>% arrange(`2020`)
  
p_riesgo_pobreza <- transpuesto_R_pobreza_UE_ord %>% select(-c(`2008`,`2009`, `2010`, `2011`, `2012`, `2013`, `2014`))  %>% 
    filter(CCAA %in% c("Navarra", "Pais_Vasco", "Baleares", "Extremadura", "ceuta", "Extremadura", "Comunidad_Valenciana", "UE_27")) %>% gt() %>%
    cols_label(CCAA = "Comunidad Autónoma") %>% tab_header(title = md("Comparación del Riesgo de Pobreza de la CV con otras CCAA y la UE-27"),
                                                           subtitle = md("El umbral de pobreza está fijado en el 60% de la mediana de ingresos de todos los hogares a nivel nacional ")) %>%
    tab_source_note(source_note = "Datos recogidos del INE, expresados en % y el año 2013 como base.") %>%
    tab_style(
      locations = cells_column_labels(columns = everything()),
      style = list(
        cell_borders(sides = "bottom", weight = px(3)),
        cell_text(weight = "bold"))
    ) %>% tab_style(
      locations = cells_title(groups = "title"),
      style     = list(
        cell_text(weight = "bold", size = 24)
      )
    ) %>%
    data_color(
      columns = `2020`,
      colors = scales::col_numeric(
        palette = c(
          "blue", "green", "orange","red"),
        domain = c(9, 32)))

p_riesgo_pobreza

```

<br>
<br>

# 3. TRABAJO

## 3.1 TASA DE EMPLEO
<br>

El trabajo es un elemento esencial en la calidad de vida de los individuos puesto que permite alcanzar mejores condiciones materiales y la integración en la sociedad.

Asimismo, tiene importantes efectos positivos sobre la salud y el bienestar subjetivo de las personas. Es importante no solo la existencia de un trabajo remunerado sino también que éste se desarrolle en condiciones de calidad, por la cantidad de tiempo que se le dedica y las interacciones con otras personas.

Para analizar este indicador y ver su implicación en la calidad de vida de la Comunidad Valenciana, empleamos un gráfico de la evolución temporal de la tasa de empleo para distintas Comunidades Autónomas.

<br>
```{r estudio3 p1, eval= TRUE, echo= FALSE, warning= FALSE, comment = FALSE}



names(tasa_empleo) <- as.matrix(tasa_empleo[1, ])
tasa_empleo <- tasa_empleo[-1, ]
tasa_empleo[] <- lapply(tasa_empleo, function(x) type.convert(as.character(x)))


names(tasa_empleo) = c("CCAA", "2006", "2007", "2008", "2009", "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018", "2019", "2020")
# Cambio el nombre de las columnas para que la primera  columna se llame ccAA y podamos pasar a formato LONG

df_long <- tasa_empleo %>% pivot_longer(cols=2:16 , names_to= "Años", values_to = "Tasa_Empleo") 
# Pasamos del formato wide al formato long

tasa_empleo_1 <- df_long %>% filter(CCAA != "Total")
# Filtramos primero para obtener solo los datos de las diferentes comunidades autónomas, eliminando el total nacional.

# Como el gráfico sería muy poco visible, vamos a comparar unicamente las CCAA con mayor y menor tasa de empleo, para posteriormente analizar la Comunidad valenciana 

tasa_empleo_2 <- tasa_empleo_1 %>% 
  filter(CCAA %in% c("Comunitat Valenciana", "Madrid, Comunidad de", "Cataluña", "Pais Vasco", "Balears, Illes", "Andalucia", "Murcia, Region de", "Extremadura"))

tasa_empleo_2$Tasa_Empleo <- as.numeric(gsub(",", ".", gsub("\\.", "", tasa_empleo_2$Tasa_Empleo))) #me cambia las comas por puntos

tasa_empleo_2$Tasa_Empleo <- as.numeric(tasa_empleo_2$Tasa_Empleo)#convierto la variable que es character en numeric

graf_empleo <- ggplot(tasa_empleo_2, aes(Años, Tasa_Empleo, color = CCAA, group= CCAA)) + geom_line() + geom_point() 
#scale_y_continuous(limits = c(20,80), breaks = seq(20, 80, by = 2))
 graf_empleo + theme(plot.subtitle = element_text(size = 11, 
    colour = "gray11", hjust = 0.5), plot.caption = element_text(size = 10, 
    colour = "gray11"), panel.grid.major = element_line(size = 0.7), 
    panel.grid.minor = element_line(size = 0.7), 
    axis.title = element_text(size = 12, 
        face = "bold", vjust = 1.75), axis.text = element_text(size = 11, 
        colour = "gray4"), plot.title = element_text(family = "serif", 
        size = 35, face = "bold.italic", 
        hjust = 0.5, vjust = 1.75), panel.background = element_rect(fill = "gray95", 
        size = 0.7), plot.background = element_rect(fill = "rosybrown3", 
        colour = "gray0", linetype = "dashed")) +
   scale_y_continuous(limits = c(35, 63), breaks = seq(35, 63, by = 5))+
   labs(title = "TASA EMPLEO", 
    x = "AÑOS", y = "TASA EMPLEO (% 16 y mas años)", 
    subtitle = "(Desde 2006 a 2020 por CCAA)", 
    caption = "Datos provenientes del INE")
 
```

<br>

Como podemos observar, las mayores tasas de empleo desde el año 2006 se han observado en **Madrid y en las Islas Baleares**, mientras que por otro lado las peores tasas se observan en **Extremadura y Andalucía** (Comunidades donde predomina en mayor medida el sector primario)

La **Comunidad Valenciana** presenta unas tasas de empleo que se situan entorno a la media española, por lo tanto, en cuanto a este indicador de empleo podríamos decir que tendríamos más oportunidad de estar empleados en la Comunidad Valenciana que en otras Comunidades Autónomas.

Como dato para comparar con la Comunidad Valenciana, a nivel nacional (en el año 2020), la tasa de empleo en España fue del 48,5%. 


<br>

<br>

## 3.2 TASA DE PARO {.tabset}

<br>


### Gráfico con la expicación

La falta de trabajo disminuye en gran medida la calidad de vida de los individuos. Esta falta produce un conjunto de efectos sociales y personales en gran medida interrelacionados, aumentando las desigualdades sociales y de salud, disminuyendo los niveles de capacitación, bienestar material y subjetivo de las personas.

Para ver que implicación tiene la tasa de paro en la calidad de vida de la Comunidad Valenciana, hemos extraido las 10 Comunidades Autónomas con mayores tasas de paro y podemos observar que dentro de ella se encuentra la Comunidad Valenciana.

<br>

```{r tasa paro, eval= TRUE, echo= FALSE, warning= FALSE, comment = FALSE}

names(tasa_paro) <- as.matrix(tasa_paro[1, ])
tasa_paro <- tasa_paro[-1, ]
tasa_paro[] <- lapply(tasa_paro, function(x) type.convert(as.character(x)))


names(tasa_paro) = c("CCAA", "2006", "2007", "2008", "2009", "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018", "2019", "2020")
# Cambio el nombre de las columnas para que la primera  columna se llame ccAA y podamos pasar a formato LONG

df_long2 <- tasa_paro %>% pivot_longer(cols=2:16 , names_to= "Años", values_to = "Tasa_Paro")
# Pasamos del formato wide al formato long

df_long2$Tasa_Paro <- as.numeric(gsub(",", ".", gsub("\\.", "", df_long2$Tasa_Paro)))

#Gráfico 10 comunidades con mayor tasa de paro (dentro se encuentra valencia)
df_ccaa <- df_long2 %>% 
  filter(Años == 2020, CCAA != "Pais Vasco" ) %>% # hemos eliminado al Pais Vasco ya que nos salía dentro del Top 10 con mas Tasa de Paro y en realidad, es el que menor tasa presenta :)
  select(CCAA , Tasa_Paro) %>%
  slice_max(Tasa_Paro, n = 10)

graf_paro <- ggplot(df_ccaa, aes(x = CCAA, y = Tasa_Paro)) + 
  geom_bar(stat = "identity",aes(fill = Tasa_Paro))

graf_paro1<- graf_paro + labs(title = "% Tasa de Paro Año 2020",
       subtitle = "10 comunidades con mas paro",
       caption = "Elaboración propia",
       x = "CCAA",
       y = "% paro") + theme_light() + 
  geom_text(aes(label = Tasa_Paro),nudge_y =0.3, colour = "black")



ggplotly(graf_paro1)


  
```
<br>





### Código

```{r Tabla Tasa de paro,eval= FALSE, echo= TRUE, warning= FALSE, comment = FALSE}

names(tasa_paro) <- as.matrix(tasa_paro[1, ])
tasa_paro <- tasa_paro[-1, ]
tasa_paro[] <- lapply(tasa_paro, function(x) type.convert(as.character(x)))


names(tasa_paro) = c("CCAA", "2006", "2007", "2008", "2009", "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018", "2019", "2020")
# Cambio el nombre de las columnas para que la primera  columna se llame ccAA y podamos pasar a formato LONG

df_long2 <- tasa_paro %>% pivot_longer(cols=2:16 , names_to= "Años", values_to = "Tasa_Paro")
# Pasamos del formato wide al formato long

df_long2$Tasa_Paro <- as.numeric(gsub(",", ".", gsub("\\.", "", df_long2$Tasa_Paro)))
#Gráfico 10 comunidades con mayor tasa de paro (dentro se encuentra valencia)
df_ccaa <- df_long2 %>% 
  filter(Años == 2020, CCAA != "Pais Vasco" ) %>% # hemos eliminado al Pais Vasco ya que nos salía dentro del Top 10 con mas Tasa de Paro y en realidad, es el que menor tasa presenta :)
  select(CCAA , Tasa_Paro) %>%
  slice_max(Tasa_Paro, n = 10)

graf_paro <- ggplot(df_ccaa, aes(x = CCAA, y = Tasa_Paro)) + 
  geom_bar(stat = "identity",aes(fill = Tasa_Paro))

graf_paro1<- graf_paro + labs(title = "% Tasa de Paro Año 2020",
       subtitle = "10 comunidades con mas paro",
       caption = "Elaboración propia",
       x = "CCAA",
       y = "% paro") + theme_light() + 
  geom_text(aes(label = Tasa_Paro),nudge_y =0.3, colour = "black")

view(df_ccaa)

graf_paro1


  
```
<br>

## Gráfico con la explicacicón


A **nivel nacional la tasa de paro en el año 2020 fue del 15,5%**, un valor superior a la tasa de paro del año 2019 que fue del 14,1%.

En el año 2020 los valores más altos en la tasa de paro correspondieron a las comunidades de: Ceuta (24,5%), Melilla (23,8%) y Canarias (22,6%).

Los valores más bajos en la tasa de paro se situaron en: País Vasco (9,5%), Comunidad Foral de Navarra (10,1%) y La Rioja (10,8%), ya que son empleos más bien vinculados a la industria.

La **tasa de paro de la Comunidad Valenciana es un tanto superior a la tasa de nivel nacional**, en concreto es del **16,2%**, y en parte esta vinculada a la temporalidad del sector servicios, entre ellos del turismo, y de las actividades vinculadas a esta actividad.


<br><br>

## 3.3 SATISFACCIÓN CON EL TRABAJO
<br>

Este indicador sobre el bienestar responde a la pregunta de ¿Cuál es su grado de satisfacción global con su trabajo actual?. Para responder a la pregunta se utiliza una escala de 0 a 10, en la que 0 significa nada satisfecho y 10 plenamente satisfecho.

Con este indicador pretendemos conocer otro aspecto de la calidad de vida que se puede encontrar en la Comunidad Valenciana y que va más alla de la dimensión material o de los ingresos percibidos

<br>

```{r Tabla, echo=FALSE, eval=TRUE}

names(satis_trab) <- as.matrix(satis_trab[1, ])
satis_trab <- satis_trab[-1, ]
satis_trab[] <- lapply(satis_trab, function(x) type.convert(as.character(x)))


names(satis_trab) = c("CCAA", "De 0 a 4", "De 5 a 6", "De 7 a 8", "De 9 a 10", "Satisfaccion Media")
# Cambio el nombre de las columnas para que la primera  columna se llame ccAA y podamos pasar a formato LONG

#paquete:


knitr::kable(satis_trab) %>%
  kableExtra::kable_styling(fixed_thead = list(enabled = T, background = "orange")) %>%  column_spec(7, bold = T, color = "white", background = "grey") %>% row_spec(7, bold = T, color = "white", background = "grey")

```

<br>

Según el Módulo sobre Bienestar del año 2018 de la Encuesta de Condiciones de Vida las **comunidades con porcentajes más altos** de personas que están muy satisfechas con el trabajo (9 y 10 puntos) corresponden a: Melilla (52,5%), Canarias (44,8%) y Aragón (31,0%).

Los **porcentajes más bajos** de personas que están muy satisfechas con el trabajo (9 y 10 puntos) corresponden a: Región de Murcia (16,7%), Andalucía (22,5%) y Comunidad de Madrid (23,1%).

Como podemos observar en la Tabla, la **Comunidad Valenciana** a nivel nacional ocupa una posición intermedia con una **satisfacción media de 7,4**, muy próxima a la media española
<br>
<br>

## 3.4 TRABAJO TEMPORAL

<br>

La temporalidad laboral supone un detrimento en la calidad de vida de los individuos porque disminuye la percepción subjetiva de seguridad en el empleo y tiene efectos negativos en la formación.

Además la temporalidad va asociada a diferentes grados de precariedad según la normativa de regulación del despido.

Por tanto, en el siguiente gráfico circular vamos a hablar del porcentaje de trabajadores que presentan contratos temporales sobre el total, es decir, pretendemos conocer el porcentaje de trabajadores que se encuentran menos protegidos tanto en el empleo como en el desempleo, ya que están poco protegidos por la regulación y son más vulnerables a los despidos.

<br>
```{r Gráfico Tasa de temporalidadd, echo=FALSE}

names(trabajo_temp) <- as.matrix(trabajo_temp[1, ])
trabajo_temp <- trabajo_temp[-1, ]
trabajo_temp[] <- lapply(trabajo_temp, function(x) type.convert(as.character(x)))


names(trabajo_temp) = c("CCAA", "2006", "2007", "2008", "2009", "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018", "2019", "2020")
# Cambio el nombre de las columnas para que la primera  columna se llame ccAA y podamos pasar a formato LONG

df_long4 <- trabajo_temp %>% pivot_longer(cols=2:16 , names_to= "Años", values_to = "Tasa_Temporalidad")
# Pasamos del formato wide al formato long

df_long4$Tasa_Temporalidad <- as.numeric(gsub(",", ".", gsub("\\.", "", df_long4$Tasa_Temporalidad)))
#install.packages("paletteer")



temp_1 <- df_long4 %>% group_by(CCAA) %>% filter(Años == 2020) %>% arrange(desc(Tasa_Temporalidad)) 

graficotemp_2020 <- ggplot(temp_1, aes(x="", y = Tasa_Temporalidad, fill=CCAA)) +     geom_bar(stat ="identity", color = "black") + 
    geom_text(aes(label = Tasa_Temporalidad), position = position_stack(vjust=0.5), color="black", size = 4, ) + 
  coord_polar(theta = "y")  + 
  theme_void() + 
  scale_fill_manual(values = c("STEELBLUE", "BLUE", "ORANGE", "RED","BROWN","GREEN", "DARKGREY", "#66CDAA","#8B2323", "#00008B", "#98F5FF", "#FF7256", "#FFF8DC", "#76EE00", "#CAFF70", "#B8860B", "#FF1493","#BF3EFF", "#FF6A6A", "#6B8E23", "DARK ORANGE"))+
  labs(title = "% TRABAJADORES CON CONTRATO TEMPORAL")
graficotemp_2020 + theme(panel.grid.major = element_line(linetype = "blank")) +labs(fill = "TASA TEMPORALIDAD") 

```
<br>

En el año 2020, un **24,1% de asalariados tenían contrato de trabajo temporal**. La comunidad con el porcentaje más bajo de asalariados con contrato temporal correspondió a la **Comunidad de Madrid (18,8%)** mientras que el porcentaje más alto de asalariados con contrato temporal en 2020 correspondió a **Extremadura (34,9%)**.

La **Comunidad Valenciana presenta una alta tasa de temporalidad (25,2%)**, la razón puede ser su dependencia al sector servicios (principalmente destaca el turismo)

<br>
<br>

# 4. SALUD Y EDUCACIÓN
<br>

La salud es otro de los aspectos importantes cuando hablamos sobre la calidad de vida de las personas. Tener unas buenas condiciones de salud son claves para poder conseguir mayores oportunidades laborales, obtener una mayor formación educativa y poder disfrutar mejor del ocio personal.
Para obtener unas buenas condiciones de salud hay que seguir unos hábitos adecuados tanto en el ámbito físico, mental y social, no solamente hay que tener en cuenta la aparición de enfermedades. 
Para analizar este punto, vamos a observar la evolución de un dato muy importante como es la esperanza de vida. Y también, cómo se encuentra el acceso a los servicios sanitarios ya que son una fuente directa a la hora de solucionar los problemas de salud de la población. 


## 4.1 Esperanza de Vida


<br>

### 4.1.1 Datos Comunidades Autónomas

En la tabla que tenemos a continuación, podemos observar cual es la esperanza de vida en las diferentes Comunidades Autónomas en el año 2020. <br>  

Los datos presentados son bastante positivos ya que, en aspectos generales, todas las comunidades tienen una esperanza de vida mayor de 80 años. Podríamos destacar a la población de las comunidades de Islas Baleares (83,46 años) y Navarra (83,36 años) como las que tienen una mayor esperanza de vida en España. Por otro lado, la población de Ceuta (79,28 años) y Melilla (78,82 años) son las que tienen una menor esperanza de vida en España, aunque sus datos siguen siendo bastante positivos.  <br>

Por lo que respecta a la Comunidad Valenciana, actualmente se encuentra en una posición intermedia en España, con una esperanza de vida de 82,36 años, llegando a superar a dos de las grandes comunidades como Cataluña y Madrid.  

<br>

```{r, echo=FALSE, eval=TRUE}

vida_hm$Total <- as.numeric(gsub(",",".", gsub("\\.","", vida_hm$Total)))
vida_hm$Total<- as.numeric(vida_hm$Total)
#Datos con el resto de comunidades
vida_ccaa <- rio::import(here::here("datos/vida_ccaa.csv"))
vida_ccaa$Total <- as.numeric(gsub(",",".", gsub("\\.","", vida_ccaa$Total)))
vida_ccaa$Total<- as.numeric(vida_ccaa$Total)

vida_ccaa2020 <- vida_ccaa %>%
  filter(Periodo == 2020) %>%
  arrange(desc(Total)) %>%
  select(`Comunidades y Ciudades Autónomas`, Total)

#Tabla
tabla_ccaa <- vida_ccaa2020 %>% gt()
tabla_ccaa <- gt::gt(vida_ccaa2020) %>%
  tab_header(title = md("**Esperanza de vida en las Comunidades Autonomas**"),
             subtitle = md("*En años*")) %>%
  tab_source_note(md("Fuente: datos de [INE](https://www.ine.es/jaxiT3/Datos.htm?t=1448)"))%>%
  cols_width(columns = c(Total) ~ px(100)) %>%
  tab_options(column_labels.border.bottom.color = "black",
              table_body.border.bottom.color = "black",
              table_body.hlines.color = "black") %>%
  tab_style(style = cell_fill(color = "lightblue"),
            locations = cells_body(columns = Total,
                                   rows = Total< 81)) %>%
  tab_style(style = cell_text(color = "white"),
            locations = cells_body(columns = Total,
                                   rows = Total< 81)) %>%
  tab_style(style = cell_fill(color = "blue"),
            locations = cells_body(columns = Total,
                                   rows = Total> 81)) %>%
  tab_style(style = cell_text(color = "white"),
            locations = cells_body(columns = Total,
                                   rows = Total >81))%>%
  tab_style(style = cell_fill(color = "purple"),
            locations = cells_body(columns = Total,
                                   rows = Total> 83)) %>%
  tab_style(style = cell_text(color = "white"),
            locations = cells_body(columns = Total,
                                   rows = Total> 83))
tabla_ccaa

#Datos para el grafico + el grafico

vida_evol <- vida_ccaa %>%
  filter(`Comunidades y Ciudades Autónomas` %in% c ("Balears, Illes", "Navarra, Comunidad Foral de", "Comunitat Valenciana", "Madrid, Comunidad de", "Cataluña"))%>%
  select(`Comunidades y Ciudades Autónomas`, Periodo, Total)
vida_evol %>%
  ggplot( aes(x=Periodo, y=Total, group= `Comunidades y Ciudades Autónomas`, color=`Comunidades y Ciudades Autónomas`)) +
  geom_line() +
  geom_point() +
  ggtitle("Evolución Esperanza de Vida") +
  theme_ft_rc() +
  scale_x_continuous(limits = c(1975, 2020), breaks = seq(1975, 2020, by = 15))+
  ylab("Numero de años") +
  transition_reveal(Periodo)
```
<br>

En este gráfico vamos a comparar cómo ha evolucionado en el tiempo la esperanza de vida en las actuales comunidades con mejores datos (Islas Baleares y Navarra) y a las comunidades de Cataluña y Madrid con la Comunidad Valenciana.  <br>

En esta evolución podemos llegar a la conclusión de que la Comunidad Valenciana, en la mayor parte del tiempo, se ha encontrado por debajo de las comunidades punteras en cuanto a esperanza de vida. Sin embargo, en el 2020, ha obtenido un resultado mayor que Cataluña y Madrid. Esto puede deberse principalmente a las consecuencias que deja la pandemia del COVID-19.  

<br>

### 4.1.2 Datos Comunidad Valenciana

Por lo que respecta a los datos en la Comunidad, la tendencia de la esperanza de vida es creciente. Es cierto, que, en este último período, se ha sufrido un descenso por culpa de la pandemia, pero el efecto no es tan grande como el que se ha podido observar en Cataluña o en Madrid.<br>  

También hay que destacar, que la esperanza de vida de las mujeres en la Comunidad Valenciana es de, aproximadamente, 5 años más que la que tienen los hombres. Esta diferencia no ha conseguido reducirse durante el período analizado entre 1975 y 2020. 

<br>
```{r , echo=FALSE, eval=TRUE}

#Grafico animado CV
vida_hm %>%
  ggplot( aes(x=Periodo, y=Total, group=Sexo, color=Sexo)) +
  geom_line() +
  geom_point() +
  ggtitle("Esperanza de vida por sexo en la Comunidad Valenciana") +
  ylab("Numero de años") +
  transition_reveal(Periodo)+
  theme_modern_rc()+
  view_follow()
```
<br> <br>
## 4.2 ACCESO A CUIDADOS SANITARIOS

Además de seguir unos buenos hábitos de vida para poder tener una buena salud, también se debe de contar con unos buenos servicios sanitarios. Estos deben de tener una buena accesibilidad en la que el paciente pueda ser atendido ante cualquier problema. Para conocer esta disponibilidad, vamos a analizar los datos de personas que no han accedido a cuidados médicos cuando lo han necesitado.  

<br>

# 4.2.1 DATOS EN LAS COMUNIDADES AUTÓNOMAS

```{r , echo=FALSE, eval=TRUE}

names(no_acceso_1) <- as.matrix(no_acceso_1[1, ])
no_acceso_1 <- no_acceso_1[-1, ]
no_acceso_1[] <- lapply(no_acceso_1, function(x) type.convert(as.character(x)))


no_acceso_1 <- no_acceso_1 %>%
  arrange(desc(`2020`)) %>%
  pivot_longer(.,!CCAA, values_to = "No Acceso 1", names_to = "year")
no_acceso_1$`No Acceso 1` <- as.numeric(gsub(",",".", gsub("\\.","", no_acceso_1$`No Acceso 1`)))
no_acceso_1$`No Acceso 1` <- as.numeric(no_acceso_1$`No Acceso 1`)


 
names(no_acceso_2) <- as.matrix(no_acceso_2[1, ])
no_acceso_2 <- no_acceso_2[-1, ]
no_acceso_2[] <- lapply(no_acceso_2, function(x) type.convert(as.character(x)))


no_acceso_2 <- no_acceso_2 %>%
  arrange(desc(`2020`)) %>%
  pivot_longer(.,!CCAA, values_to = "No Acceso 2", names_to = "year")

no_acceso_2$`No Acceso 2` <- as.numeric(gsub(",",".", gsub("\\.","", no_acceso_2$`No Acceso 2`)))
no_acceso_2$`No Acceso 2` <- as.numeric(no_acceso_2$`No Acceso 2`)

#Union tablas
df_inner <- inner_join(no_acceso_1, no_acceso_2)

#filtrados
comparacion_ccaa <- df_inner %>%
  filter(year == 2020) %>%
  select(CCAA, `No Acceso 1`, `No Acceso 2`)

#Tabla definitiva

tabla_com <- comparacion_ccaa %>% gt()
tabla_com <- gt::gt(comparacion_ccaa) %>%
  tab_header(title = md("**Datos No Acceso a Servicios Sanitarios 2020**"),
             subtitle = md("*Datos en %*")) %>%
  tab_source_note(md("**Fuente**: datos de [INE](https://www.ine.es/ss/Satellite?L=es_ES&c=INESeccion_C&cid=1259944487867&p=1254735110672&pagename=ProductosYServicios%2FPYSLayout&param1=PYSDetalleFichaIndicador&param3=1259937499084)")) %>%
  tab_source_note(md("**No Acceso 1**: muy caro; muy lejos para acceder; problemas de lista de espera")) %>%
  tab_source_note(md("**No Acceso 2**:no disponer de tiempo; no conoce ningún buen especialista; miedo al médico, hospitales, exploraciones médicas o tratamiento; esperar y ver si el problema mejora; otras razones")) %>%
  cols_width(columns = c(`No Acceso 1`) ~ px(100)) %>%
  cols_width(columns = c(`No Acceso 2`) ~ px(100)) %>%
  tab_options(column_labels.border.bottom.color = "black",
              table_body.border.bottom.color = "black",
              table_body.hlines.color = "black") %>%
  tab_style(style = cell_fill(color = "brown1"),
            locations = cells_body(columns = `No Acceso 1`,
                                   rows = `No Acceso 1`> 1)) %>%
  tab_style(style = cell_text(color = "white"),
            locations = cells_body(columns = `No Acceso 1`,
                                   rows = `No Acceso 1`> 1)) %>%
  tab_style(style = cell_fill(color = "brown1"),
            locations = cells_body(columns = `No Acceso 2`,
                                   rows = `No Acceso 2`> 1)) %>%
  tab_style(style = cell_text(color = "white"),
            locations = cells_body(columns = `No Acceso 2`,
                                   rows = `No Acceso 2` > 1)) %>%
  tab_style(style = cell_borders(color = "black", weight = px(3)),
            locations = cells_body(columns = `No Acceso 1`,
                                   rows = `No Acceso 1`>= 0)) %>%
  tab_style(style = cell_borders(color = "black", weight = px(3)),
            locations = cells_body(columns = `No Acceso 2`,
                                   rows = `No Acceso 2`>= 0))
tabla_com
```
<br> <br>

En esta tabla podemos ver los datos acerca de las personas que no han podido acceder a los servicios sanitarios cuando lo han necesitado. Este dato se divide en dos tipos de no acceso.  <br>

Las razones de no acceso 1 incluye todas aquellas razones acerca de que el servicio es caro y el paciente no se lo puede permitir. También incluye la lejanía del centro de salud en el que tiene que ser atendido. Y, los problemas de las listas de espera ya que algunos pacientes necesitan una intervención cuanto antes y se ven con restricciones.  <br>

En cuanto a las razones de no acceso 2 incluye aquellas acerca de no disponer de tiempo, no conocer un buen especialista, el miedo del paciente a ir al médico o a los hospitales o a exponerse a algún tratamiento, y que el propio paciente prefiere esperar a ver si el problema mejora en vez de acudir al centro sanitario y ser tratado.  <br>

En el año 2020, la comunidad en la que un mayor porcentaje de población tuvo problemas de no acceso 1 fue Canarias con un 1,4%. Muy cerca de ella, encontramos a la Comunidad Valenciana con un 0,8%. Además, hay varias comunidades que se encontraron con un 0% de su población que se acogió a estos problemas como Galicia, Cantabria, Aragón, Ceuta y Melilla. <br>

 

En cuanto a las razones de no acceso 2, la comunidad con mayor porcentaje de población que tuvo ese tipo de problemas fue la Comunidad Valenciana con un 2,8%. En este tipo de razones es donde más comunidades tienen mínimo un 1% de su población afectada a excepción de Ceuta que es la única con un 0%.<br> 

# 4.2.2 DATOS EN LA COMUNIDAD VALENCIANA

```{r , echo=FALSE, eval=TRUE}

no_acceso_cv <- df_inner %>%
  filter(CCAA %in% c ( "Comunitat Valenciana"))

grafico_cv1 <- ggplot(no_acceso_cv, aes(year, `No Acceso 1`, fill = CCAA)) + geom_col(position = "dodge")+
  theme_igray()+
  labs(title = "Datos de No Acceso por Razón 1")+
  labs(subtitle = "Datos CV")+
  labs(caption = "Datos provenientes del INE")+
  theme(axis.text.x = element_text(colour = "black", size = 8, angle = 90, hjust = 0.5, vjust = 0.5))

grafico_cv1

grafico_cv2 <- ggplot(no_acceso_cv, aes(year, `No Acceso 2`, fill = CCAA)) +
  geom_col(position = "dodge") +
  theme_igray()+
  labs(title = "Datos de No Acceso por Razón 2")+
  labs(subtitle = "Datos CV")+
  labs(caption = "Datos provenientes del INE")+
  theme(axis.text.x = element_text(colour = "black", size = 8, angle = 90, hjust = 0.5, vjust = 0.5))
  
grafico_cv2


```
<br> <br>

En cuanto a los datos en la Comunidad Valenciana, vamos a observar la evolución de los problemas de acceso al sistema sanitario por las razones de no acceso 1. <br>

Durante el período 2004-2006, llegó a tener un 2% de la población afectada, pero consiguió descender ese porcentaje hasta el 2013. Finalmente, se volvieron a reducir los datos hasta el 2020, donde ha ascendido hasta un 0,8% de la población. Es muy probable que esto se deba a las consecuencias de la pandemia del COVID-19 que ha supuesto una aglomeración de pacientes.  

 <br>

En cuanto a los datos sobre las razones de no acceso 2, vemos que el porcentaje de población que se acogió a estos problemas comparando las razones de no acceso 1 es mucho mayor. El año donde más afectó fue en 2010 donde llego al 10,8% de la población.  
<br>
Un dato positivo, es que se pudo reducir en una gran medida estas cifras en el periodo 2017-2019. Hasta que, en el año 2020, a causa del COVID-19, ha vuelto a aumentar este porcentaje hasta el 2,8% y siendo la peor Comunidad Autónoma.  
<br>
 

En conclusión, la posición de la Comunidad Valenciana comparando con las comunidades no es muy buena ya que en uno de los tipos de razones es la que más población tiene problemas de acceso al servicio sanitario. Sin embargo, un aspecto positivo es que, antes de llegar la pandemia en 2020, se han conseguido reducir esos datos, lo que significa que los problemas para acceder al sistema sanitario se han solucionado. 

<br> <br>

## 4.3 NIVEL DE EDUCACIÓN DE LA POBLACIÓN

La educación es un indicador importante para la persona ya que de manera directa consigue que el individuo aprenda nuevos conocimientos, pero otorga otros beneficios de manera indirecta como un aumento de su bienestar y de su calidad de vida.  <br>

La manera en la que la educación otorga una mayor calidad de vida en el individuo es que puede conseguir un mejor empleo en el futuro el cual le otorgue un salario mayor que le permita vivir en unas condiciones agradables. Al mismo tiempo, la educación permite al individuo conocer mejores estilos de vida saludables con efectos positivos en su salud y le genera unas mayores habilidades para que su integración en la sociedad sea más sencilla.  

<br>

### 4.3.1 NIVEL DE EDUCACIÓN 0-2
```{r , echo=FALSE, eval=TRUE}

#Nivel 0-2

names(educ_02) <- as.matrix(educ_02[1, ])
educ_02 <- educ_02[-1, ]
educ_02[] <- lapply(educ_02, function(x) type.convert(as.character(x)))


#Editando datos

educ2020 <- educ_02 %>%
  select(CCAA,`2018`,`2019`, `2020`)%>%
  arrange(desc(`2020`))

#Tabla 1

tabla2020 <- educ2020 %>% gt()
tabla2020 <- gt::gt(educ2020)


tabla2020 <- tabla2020 %>% 
  tab_header(title = md("**Nivel de formación alcanzado por la población de 16 a 64 años (%)**"),
             subtitle = md("*Nivel 0-2*")) %>%
  tab_source_note(md("Fuente: datos de [INE](https://www.ine.es/ss/Satellite?L=es_ES&c=INESeccion_C&cid=1259949477082&p=1254735110672&pagename=ProductosYServicios%2FPYSLayout&param1=PYSDetalleFichaIndicador&param3=1259937499084)"))%>%
  tab_source_note(md("**Nivel 0-2**:preescolar, primaria y 1ª etapa de educación secundaria"))


tabla2020 <- tabla2020 %>% 
  cols_width(columns = c(`2020`) ~ px(100))



tabla2020 <- tabla2020 %>%
  tab_options(column_labels.border.bottom.color = "black",
              table_body.border.bottom.color = "black",
              table_body.hlines.color = "black")


tabla2020 <- tabla2020 %>%
  tab_style(style = cell_fill(color = "red"),
            locations = cells_body(columns = `2020`,
                                   rows = `2020`< 35)) %>%
  tab_style(style = cell_text(color = "white"),
            locations = cells_body(columns = `2020`,
                                   rows = `2020`< 35)) %>%
  tab_style(style = cell_fill(color = "orange"),
            locations = cells_body(columns = `2020`,
                                   rows = `2020`> 35)) %>%
  tab_style(style = cell_text(color = "white"),
            locations = cells_body(columns = `2020`,
                                   rows = `2020` >35))%>%
  tab_style(style = cell_fill(color = "green"),
            locations = cells_body(columns = `2020`,
                                   rows = `2020`> 45)) %>%
  tab_style(style = cell_text(color = "white"),
            locations = cells_body(columns = `2020`,
                                   rows = `2020`> 45))

tabla2020

#Trasnformando datos

educ_max02 <- educ_02 %>%
  arrange(desc(`2020`)) %>%
  slice_max(`2020`, n=10)%>%
  pivot_longer(.,!CCAA, values_to = "poblacion", names_to = "year") %>%
  filter(between(year,2013,2020)) %>%
  filter(CCAA %in% c ("Extremadura","Ceuta", "Comunitat Valenciana"))
educ_max02$poblacion <- as.numeric(gsub(",",".", gsub("\\.","", educ_max02$poblacion)))
educ_max02$poblacion<- as.numeric(educ_max02$poblacion)

educ_cv <- educ_02 %>%
  arrange(desc(`2020`)) %>%
  slice_min(`2020`, n=10)%>%
  pivot_longer(.,!CCAA, values_to = "poblacion", names_to = "year") %>%
  filter(between(year,2013,2020)) %>%
  filter(CCAA %in% c ("Madrid, Comunidad de","Cataluna", "Comunitat Valenciana", "Aragon"))
#Grafico 1

grafico_educmax <- ggplot(educ_max02, aes(year, poblacion, fill = CCAA)) + geom_col(position = "dodge")+
  theme(axis.text.x = element_text(colour = "black", size = 8, angle = 90, hjust = 0.5, vjust = 0.5))+
  theme(axis.title.y = element_text(size=8, angle = 90, hjust = 0.5, vjust = 0.5))+
  labs(title = "Nivel de formación alcanzado por la población de 16 a 64 años (%)")+
  labs(subtitle = "Comparación de la Comunitat Valenciana con Ceuta y Extremadura (Nivel 0-2)")+
  labs(caption = "Datos provenientes del INE")

  grafico_educmax

#Grafico 2
grafico_educmin <- ggplot(educ_cv, aes(year, poblacion, fill = CCAA)) + geom_col(position = "dodge")+
  labs(title = "Nivel de formación alcanzado por la población de 16 a 64 años (%)")+
  labs(subtitle = "Comparación de la Comunitat Valenciana con Aragón, Cataluña, Madrid (Nivel 0-2)")+
  labs(caption = "Datos provenientes del INE")+
  theme(axis.text.x = element_text(colour = "black", size = 8, angle = 90, hjust = 0.5, vjust = 0.5))
  
grafico_educmin



```
<br>
<br>

En cuanto al nivel de formación 0-2, acoge a todos aquellos estudiantes que hayan recibido una educación de preescolar, primaria y 1º etapa de educación secundaria. Digamos que este es el nivel de educación más básica, por tanto, un nivel de educación más bajo supone unos beneficios básicos para el individuo.  
<br>
 

Como se puede observar en la tabla, vemos como Extremadura es la comunidad con más población con solo estudios básicos con un 51.4%. La situación de la Comunidad Valenciana en esta tabla es una posición intermedia baja, aunque su dato se podría considerar positivo ya que menos de la mitad de la población (un 38,5%) tiene una formación básica.  

 <br>

Si comparamos estos datos con las dos comunidades con mayor población con nivel 0-2, se observa que la Comunidad Valenciana ha estado siempre por debajo, y cada vez se ha ido reduciendo más. Sin embargo, al comparar con las comunidades con menor población con nivel 0-2, la Comunidad Valenciana no ha conseguido reducir las distancias con comunidades como Madrid.  
<br>

### 4.3.2 NIVEL DE EDUCACIÓN 3-8

En cuanto al nivel 3-8, este hace referencia a la población que ha recibido una educación de 2ª etapa de secundaria y postsecundaria no superior, 1º ciclo y 2º ciclo de educación superior y doctorado.  

Este es el nivel de formación más alto que un individuo puede conseguir. De esta manera, el individuo puede conseguir un mayor nivel de renta en el futuro, un empleo con mejores condiciones laborales, etc. <br>

```{r , echo=FALSE, eval=TRUE}

#Nivel 3-8:

names(educ_38) <- as.matrix(educ_38[1, ])
educ_38 <- educ_38[-1, ]
educ_38[] <- lapply(educ_38, function(x) type.convert(as.character(x)))




educ2038 <- educ_38 %>%
  select(CCAA,`2018`,`2019`, `2020`)%>%
  arrange(desc(`2020`))

#tabla

tabla2038 <- educ2038 %>% gt()
tabla2038 <- gt::gt(educ2038) %>%
  tab_header(title = md("**Nivel de formación alcanzado por la población de 16 a 64 años (%)**"),
             subtitle = md("*Nivel 3-8*")) %>%
  tab_source_note(md("Fuente: datos de [INE](https://www.ine.es/ss/Satellite?L=es_ES&c=INESeccion_C&cid=1259949477082&p=1254735110672&pagename=ProductosYServicios%2FPYSLayout&param1=PYSDetalleFichaIndicador&param3=1259937499084)"))%>%
  tab_source_note(md("**Nivel 3-8**:2ª etapa de educación secundaria y postsecundaria no superior, 1º y 2º ciclo de educación superior y doctorado")) %>%
  cols_width(columns = c(`2020`) ~ px(100)) %>%
  tab_options(column_labels.border.bottom.color = "black",
              table_body.border.bottom.color = "black",
              table_body.hlines.color = "black") %>%
  tab_style(style = cell_fill(color = "red"),
            locations = cells_body(columns = `2020`,
                                   rows = `2020`< 50)) %>%
  tab_style(style = cell_text(color = "white"),
            locations = cells_body(columns = `2020`,
                                   rows = `2020`< 50)) %>%
  tab_style(style = cell_fill(color = "orange"),
            locations = cells_body(columns = `2020`,
                                   rows = `2020`> 50)) %>%
  tab_style(style = cell_text(color = "white"),
            locations = cells_body(columns = `2020`,
                                   rows = `2020` >50))%>%
  tab_style(style = cell_fill(color = "green"),
            locations = cells_body(columns = `2020`,
                                   rows = `2020`> 60)) %>%
  tab_style(style = cell_text(color = "white"),
            locations = cells_body(columns = `2020`,
                                   rows = `2020`> 60))
tabla2038
#Transformando datos

educ_max38 <- educ_38 %>%
  arrange(desc(`2020`)) %>%
  slice_max(`2020`, n=10)%>%
  pivot_longer(.,!CCAA, values_to = "poblacion", names_to = "year") %>%
  filter(between(year,2013,2020)) %>%
  filter(CCAA %in% c ("Pais Vasco","Madrid, Comunidad de", "Comunitat Valenciana"))

#Grafico 3

grafico_educmax38 <- ggplot(educ_max38, aes(year, poblacion, fill = CCAA)) + geom_col(position = "dodge")+
  theme(axis.text.x = element_text(colour = "black", size = 8, angle = 90, hjust = 0.5, vjust = 0.5))+
  labs(title = "Nivel de formación alcanzado por la población de 16 a 64 años (%)")+
  labs(subtitle = "Comparación de la Comunitat Valenciana con País Vasco, Madrid (Nivel 3-8)")+
  labs(caption = "Datos provenientes del INE")
  
grafico_educmax38

#Transformando datos

educ_cv38 <- educ_38 %>%
  arrange(desc(`2020`)) %>%
  slice_min(`2020`, n=15)%>%
  pivot_longer(.,!CCAA, values_to = "poblacion", names_to = "year") %>%
  filter(between(year,2013,2020)) %>%
  filter(CCAA %in% c ("Andalucia","Murcia, Region de", "Comunitat Valenciana", "Balears, Illes"))
#Grafico 4

grafico_educmin38 <- ggplot(educ_cv38, aes(year, poblacion, fill = CCAA)) + geom_col(position = "dodge")+
  theme(axis.text.x = element_text(colour = "black", size = 8, angle = 90, hjust = 0.5, vjust = 0.5))+
  labs(title = "Nivel de formación alcanzado por la población de 16 a 64 años (%)")+
  labs(subtitle = "Comparación de la Comunitat Valenciana con Andalucía, Islas Baleares, Murcia (Nivel 3-8)")+
  labs(caption = "Datos provenientes del INE")

grafico_educmin38
```

<br>
<br>

La Comunidad Autónoma con mayor nivel de educación de su población es el País Vasco con un total de 73,8%, aumentando sus datos cada año. La situación de la Comunidad Valenciana es intermedia, aunque su dato es positivo ya que más del 50% de su población (un 61,5%) tiene una formación elevada lo que podría llegar a un aumento en su calidad de vida.  

 <br>

En comparación con las mejores Comunidades Autónomas en cuanto a formación educativa, la Comunidad Valenciana se encuentra muy lejos de Madrid y del País Vasco. Aunque, hay que destacar que el nivel de formación ha tenido una evolución creciente durante el tiempo.  

 
<br>
 

En conclusión, se podría considerar que el nivel educativo en la Comunidad Valenciana es elevado ya que más del 50% de su población tiene estudios de nivel 3-8. Aunque, tiene una gran diferencia con las mejores Comunidades Autónomas.<br> <br>

## 4.4 NIVEL DE ABANDONO ESCOLAR

Uno de los aspectos importantes a tener en cuenta es el abandono escolar. El abandono escolar supone que un individuo carezca de educación, con sus correspondientes consecuencias en la calidad de vida. Si antes decíamos que con unos estudios elevados, se conseguía aumentar las posibilidades de mayor empleo, mayor salud, etc, si un individuo abandona su formación se verá privado de estas posibilidades de mejorar su calidad de vida.  <br>

Es por ello que para una sociedad es muy importante mantener a los jóvenes en el ámbito educativo para que puedan desarrollar sus habilidades e integrarse mejor y conseguir tanto resultados positivos para el propio individuo, como ofrecer beneficios a la sociedad. <br>

 

Los datos de abandono escolar estudian a los individuos entre 18 a 24 años que no ha completado la 2ª etapa de secundaria.  
<br>
En el siguiente gráfico observamos los datos de abandono escolar en las Comunidades Autónomas durante el año 2020. Las zonas donde el abandono es mayor son en Ceuta (25,5%) y en Melilla (22,8%). Respecto a la Comunidad Valenciana, se encuentra dentro de la media de España, y tiene un 15% de población entre 18 y 24 años que abandona sus estudios. 

<br>

```{r , echo=FALSE, eval=TRUE}

#Parte del abandono escolar


names(abandono) <- as.matrix(abandono[1, ])
abandono <- abandono[-1, ]
abandono[] <- lapply(abandono, function(x) type.convert(as.character(x)))



abandono_cv <- abandono %>%
  arrange(desc(`2020`)) %>%
  pivot_longer(.,!CCAA, values_to = "poblacion", names_to = "year")  %>%
  filter(CCAA %in% c ("Comunitat Valenciana"))

abandono_cv$poblacion <- as.numeric(gsub(",",".", gsub("\\.","", abandono_cv$poblacion)))
abandono_cv$poblacion <- as.numeric(abandono_cv$poblacion)

abandono_cv$year <- as.numeric(gsub(",",".", gsub("\\.","", abandono_cv$year)))
abandono_cv$year <- as.numeric(abandono_cv$year)


abandono_ccaa <- abandono %>%
  arrange(`2020`) %>%
  pivot_longer(., !CCAA, values_to = "poblacion", names_to = "year") %>%
  filter(year == 2020)
  
abandono_ccaa$poblacion <- as.numeric(gsub(",",".", gsub("\\.","", abandono_ccaa$poblacion)))
abandono_ccaa$poblacion <- as.numeric(abandono_ccaa$poblacion)


#Grafico bueno
g_aban <- ggplot(abandono_ccaa, aes(x=CCAA, y=poblacion)) +
  geom_segment( aes(x=CCAA, xend=CCAA, y=0, yend=poblacion)) +
  geom_point( size=5, color="red", fill=alpha("orange", 0.3), alpha=0.7, shape=21, stroke=2) +
  theme_light() +
  coord_flip() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank()
  )+
  labs(title = "Datos abandono escolar en las Comunidades Autonomas")+
  labs(subtitle = "Año 2020")+
  labs(caption = "Datos (en %) provenientes del INE")

g_aban
```
<br><br>


# 5. OTROS INDICADORES

<br>

## 5.1 POBLACIÓN QUE SUFRE PROBLEMAS DE RUIDOS PRODUCIDOS POR VECINOS O DEL EXTERIOR

<br>
La contaminación acústica se define como el exceso de ruido ambiental y afecta a la salud de las personas (estrés, pérdida de la audición, trastornos del sueño) y por tanto a su calidad de vida.

A partir de este gráfico se muestra el porcentaje de personas que tienen la vivienda con problemas de ruidos producidos por los vecinos o procedentes del exterior (tráfico, negocios, fábricas colindantes).

Para analizar la situación de la Comunidad Valenciana mostramos dos gráficos en el que se diferencian las Comunidades Autónomas con más porcentaje de población que sufre ruidos frente a las Comunidades menos afectadas
<br>
```{r Gráfico ruidos ,echo=FALSE, eval=TRUE}

names(ruidos) <- as.matrix(ruidos[1, ])
ruidos <- ruidos[-1, ]
ruidos[] <- lapply(ruidos, function(x) type.convert(as.character(x)))



names(ruidos) = c("CCAA", "2004", "2005", "2006", "2007", "2008", "2009", "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018", "2019", "2020")
# Cambio el nombre de las columnas para que la primera  columna se llame ccAA y podamos pasar a formato LONG


df_long5 <- ruidos %>% pivot_longer(cols=2:18 , names_to= "Años", values_to = "porcent_pob_ruidos") 
df_long_5_2 <- df_long5 %>% filter(Años == 2020)
# Pasamos del formato wide al formato long
df_long_5_2$porcent_pob_ruidos <- as.numeric(gsub(",", ".", gsub("\\.", "", df_long_5_2$porcent_pob_ruidos)))

#install.packages("ggthemes")


# 4 comunidades con mas ruido
mas_ruido<- df_long_5_2 %>% filter(CCAA %in% c("Ceuta", "Murcia",
"Canarias", "Melilla", "CValenciana"))

ruido1 <- ggplot(mas_ruido, aes(CCAA,porcent_pob_ruidos))+ geom_col()+ labs(title = "CCAA CON MAS RUIDOS", subtitle = "% poblacion sufre ruidos por CCAA", x = "CCAA", y = "% poblacion ruidos")+ 
  theme_solarized() 


# 4 comunidades con menos ruido

menos_ruido<- df_long_5_2 %>% filter(CCAA %in% c("Galicia", "CastillaLeon",
"CastillaLaMancha", "Extremadura"))

ruido2 <- ggplot(menos_ruido, aes(CCAA,porcent_pob_ruidos))+ 
  geom_col()+ scale_y_continuous(limits = c(0, 25), breaks = seq(0, 25, by = 5)) + labs(title = "CCAA CON MENOS RUIDOS", subtitle = "% poblacion sufre ruidos por CCAA", x = "CCAA", y = "% poblacion ruidos")+ 
  theme_solarized() 


ruido1 
ruido2

```
<br>

Como dato a **nivel nacional**, en el año 2020 un **21,9%** de personas declaraba problemas de ruidos producidos por vecinos o del exterior, y como podemos observar en los gráficos, la **Comunidad Valenciana** se encuentra un poco alejada de las 4 Comunidades más afectadas por ruidos, pero se encuentra por encima del total nacional con un **26%** de la población afectada por ruidos.
<br> <br>

## 5.2 DELINCUENCIA O VANDALISMO EN LA ZONA

La seguridad física y la comodidad de poder realizar cualquier actividad es muy importante para los individuos y afecta directamente a su bienestar. Las condiciones del entorno en el que se encuentran las personas llega a ser importante para medir su calidad de vida. Es por ello que vamos a comprobar cuál es el nivel de delincuencia o vandalismo en las distintas Comunidades Autónomas. <br>

### 5.2.1 DATOS EN LAS COMUNIDADES AUTÓNOMAS

En esta tabla podemos ver como la zona con mayor porcentaje de delincuencia es Melilla con un 35,5%. Por lo que respecta a la Comunidad Valenciana, se encuentra en unos puestos bajos y con un índice relativamente pequeño, de un 7,7%.

<br>

```{r , echo=FALSE, eval=TRUE}


delincuencia$Total <- as.numeric(gsub(",",".", gsub("\\.","", delincuencia$Total)))
delincuencia$Total<- as.numeric(delincuencia$Total)

delin_ccaa <- delincuencia %>%
  filter( periodo == 2020)%>%
  arrange(desc(Total))%>%
  select(`Comunidades y Ciudades Autónomas`, Total)

#Tabla Datos

del_ccaa <- delin_ccaa %>% gt()
del_ccaa <- gt::gt(delin_ccaa) %>%
  tab_header(title = md("**Delincuencia en las Comunidades Autonomas. Año 2020**"),
             subtitle = md("*En %*")) %>%
  tab_source_note(md("Fuente: datos de [INE](https://www.ine.es/jaxi/Datos.htm?path=/t00/ICV_ant/dim6/&file=61201.px)"))%>%
  cols_width(columns = c(Total) ~ px(80)) %>%
  tab_options(column_labels.border.bottom.color = "black",
              table_body.border.bottom.color = "black",
              table_body.hlines.color = "black") %>%
  tab_style(style = cell_fill(color = "olivedrab1"),
            locations = cells_body(columns = Total,
                                   rows = Total > 2)) %>%
  tab_style(style = cell_text(color = "white"),
            locations = cells_body(columns = Total,
                                   rows = Total > 2))%>%
  tab_style(style = cell_fill(color = "chartreuse2"),
            locations = cells_body(columns = Total,
                                   rows = Total > 5.5)) %>%
  tab_style(style = cell_text(color = "white"),
            locations = cells_body(columns = Total,
                                   rows = Total > 5.5)) %>%
  tab_style(style = cell_fill(color = "chartreuse3"),
            locations = cells_body(columns = Total,
                                   rows = Total > 7.5)) %>%
  tab_style(style = cell_text(color = "white"),
            locations = cells_body(columns = Total,
                                   rows = Total > 7.5))%>%
  tab_style(style = cell_fill(color = "gold3"),
            locations = cells_body(columns = Total,
                                   rows = Total > 10)) %>%
  tab_style(style = cell_text(color = "white"),
            locations = cells_body(columns = Total,
                                   rows = Total > 10)) %>%
  tab_style(style = cell_fill(color = "gold"),
            locations = cells_body(columns = Total,
                                   rows = Total > 15)) %>%
  tab_style(style = cell_text(color = "white"),
            locations = cells_body(columns = Total,
                                   rows = Total > 15))%>%
  tab_style(style = cell_fill(color = "gold"),
            locations = cells_body(columns = Total,
                                   rows = Total > 20)) %>%
  tab_style(style = cell_text(color = "white"),
            locations = cells_body(columns = Total,
                                   rows = Total > 20))%>%
  tab_style(style = cell_fill(color = "firebrick3"),
            locations = cells_body(columns = Total,
                                   rows = Total > 25)) %>%
  tab_style(style = cell_text(color = "white"),
            locations = cells_body(columns = Total,
                                   rows = Total > 25)) %>%
  tab_style(style = cell_fill(color = "firebrick1"),
            locations = cells_body(columns = Total,
                                   rows = Total > 30)) %>%
  tab_style(style = cell_text(color = "white"),
            locations = cells_body(columns = Total,
                                   rows = Total > 30))
del_ccaa


#Top delincuencia

delin_top <- delincuencia %>%
  filter(`Comunidades y Ciudades Autónomas` %in% c ("Melilla", "Ceuta", "Murcia, Región de", "Canarias", "Cataluña"))%>%
  filter(between (periodo, 2010,2020))

p_top <- delin_top %>%
  ggplot( aes(x=periodo, y=Total, group= `Comunidades y Ciudades Autónomas`, color=`Comunidades y Ciudades Autónomas`)) +
  geom_line() +
  geom_point() +
  ggtitle("Top 5 CCAA - Delincuencia") +
  ylab("% de población total") +
  transition_reveal(periodo)+
  scale_x_continuous(limits = c(2010, 2020), breaks = seq(2010, 2020, by = 4)) +
  theme_solarized()
p_top

#Top menos delincuencia

delin_topmenos <- delincuencia %>%
  filter(`Comunidades y Ciudades Autónomas` %in% c ("Cantabria", "Rioja, La", "Asturias, Principado de", "Navarra, Comunidad Foral de", "Galicia"))%>%
  filter(between (periodo, 2010,2020))

p_min <- delin_topmenos %>%
  ggplot( aes(x=periodo, y=Total, group= `Comunidades y Ciudades Autónomas`, color=`Comunidades y Ciudades Autónomas`)) +
  geom_line() +
  geom_point() +
  ggtitle("Top 5 CCAA - Con menos Delincuencia") +
  theme_solarized() +
  ylab("% de población total") +
  scale_x_continuous(limits = c(2010, 2020), breaks = seq(2010, 2020, by = 4)) + transition_reveal(periodo)

p_min

```
<br><br>

### 5.2.2 DATOS EN LA COMUNIDAD VALENCIANA

Para concluir como ha evolucionado los datos en la Comunidad Valenciana, podemos observar como en el periodo 2005-2010, la delincuencia era bastante elevada llegando a estar en un 25%. Pero, la tendencia de este dato ha sido decreciente y esto es bastante positivo para la calidad de vida de la población de la Comunidad Valenciana 

<br>
```{r , echo=FALSE, eval=TRUE}

#Delincuencia CV

delin_cv <- delincuencia %>%
  filter(`Comunidades y Ciudades Autónomas` %in% c ("Comunitat Valenciana"))

#Grafico delincuencia CV

p_delcv <- delin_cv %>%
  ggplot( aes(x=periodo, y=Total, group= `Comunidades y Ciudades Autónomas`, color=`Comunidades y Ciudades Autónomas`)) +
  geom_line() +
  geom_point() +
  ggtitle("Delincuencia en la Comunidad Valenciana") +
  theme_ipsum() +
  ylab("% de población total") +
  transition_reveal(periodo) 

p_delcv

```
<br><br>

# 6. ÍNDICE DE BUENA VIDA
<br>

A lo largo del trabajo nos hemos planteado algo que vosotros también seguramente os habéis preguntado, ¿Dónde realmente se sitúa la Comunidad Valenciana en comparación con las otras Comunidades Autónomas?  Ya que este es el objetivo final y la razón de ser de este trabajo.
Esta es la razón por la cual hemos creado nuestro propio Índice: “Una Vida Mejor” ®. <br>
Nos hemos basado/inspirado en el “Better Life Index” de la OCDE que surge como una forma alternativa de comparar el bienestar entre distintos países, en lugar del Producto Interior Bruto. El Índice lo hemos basado en la mayoría de los indicadores que hemos ido analizando y representando gráficamente durante nuestro trabajo. <br>
Hemos incluido en nuestro Índice variables de todo tipo, tanto objetivos y subjetivos. Esto nos permite realizar un análisis exhaustivo cuantitativo y cualitativo tomando en consideración datos “puros” (como valores monetarios) y datos “personales” (como la satisfacción personal con un tema). En nuestro caso hemos considerado un peso igual de las 4 categorías para que el resultado no presente ningún sesgo a favor de ciertas variables. <br>
El índice lo hemos creado mediante una función de normalización con una escala de 0 a 1, siendo 0 el valor más pequeño y 1 el valor más elevado.<br>
A continuación, os presentaremos el ranking de cada uno de los 14 indicadores y la situación de cada CCAA en comparación con los demás.
<br>

## 6.1 Índices de los 14 indicadores

```{r Limpieza de datos , echo=FALSE, eval=TRUE}
#Limpieza de datos---------
#Limpieza de datos de tasa empleo, para hacer ranking
names(df_tasa_empleo) <- as.matrix(df_tasa_empleo[1, ])
df_tasa_empleo <- df_tasa_empleo[-c(1:3,23), ]
df_tasa_empleo[] <- lapply(df_tasa_empleo, function(x) type.convert(as.character(x)))

df_tasa_empleo <- df_tasa_empleo[-1]
df_tasa_empleo <- data.frame(lapply(df_tasa_empleo, function(x) gsub(",", ".", x, fixed = TRUE)))
df_tasa_empleo <- as.data.frame(sapply(df_tasa_empleo, as.numeric))

df_tasa_empleo$CCAA <- CCAA_sin_UE_sin_ord
df_tasa_empleo <- df_tasa_empleo  %>% select(CCAA, everything())
colnames (df_tasa_empleo) <- gsub("X", "", colnames(df_tasa_empleo))

#Limpieza de datos de tasa paro, para hacer ranking
names(df_tasa_paro) <- as.matrix(df_tasa_paro[1, ])
df_tasa_paro <- df_tasa_paro[-c(1:2), ]
df_tasa_paro[] <- lapply(df_tasa_paro, function(x) type.convert(as.character(x)))

df_tasa_paro <- df_tasa_paro[-1]
df_tasa_paro <- data.frame(lapply(df_tasa_paro, function(x) gsub(",", ".", x, fixed = TRUE)))
df_tasa_paro <- as.data.frame(sapply(df_tasa_paro, as.numeric))

df_tasa_paro$CCAA <- CCAA_sin_UE_sin_ord
df_tasa_paro <- df_tasa_paro %>% select(CCAA, everything())
colnames (df_tasa_paro) <- gsub("X", "", colnames(df_tasa_paro))

#Limpieza de datos de satisfacción trabajo, para hacer ranking
names(df_satis_trab) <- as.matrix(df_satis_trab[1, ])
df_satis_trab <- df_satis_trab[-c(1:3), ]
df_satis_trab[] <- lapply(df_satis_trab, function(x) type.convert(as.character(x)))

df_satis_trab <- df_satis_trab[-1]
df_satis_trab <- data.frame(lapply(df_satis_trab, function(x) gsub(",", ".", x, fixed = TRUE)))
df_satis_trab <- as.data.frame(sapply(df_satis_trab, as.numeric))

df_satis_trab$CCAA <- CCAA_sin_UE_sin_ord
df_satis_trab <- df_satis_trab %>% select(CCAA, everything())

#Limpieza de datos de trabajo temporal, para hacer ranking
names(df_trabajo_temp) <- as.matrix(df_trabajo_temp[1, ])
df_trabajo_temp <- df_trabajo_temp[-c(1:3), ]
df_trabajo_temp <- lapply(df_trabajo_temp, function(x) type.convert(as.character(x)))

df_trabajo_temp <- df_trabajo_temp[-1]
df_trabajo_temp <- data.frame(lapply(df_trabajo_temp, function(x) gsub(",", ".", x, fixed = TRUE)))
df_trabajo_temp <- as.data.frame(sapply(df_trabajo_temp, as.numeric))

df_trabajo_temp$CCAA <- CCAA_sin_UE_sin_ord
df_trabajo_temp <- df_trabajo_temp %>% select(CCAA, everything())
colnames (df_trabajo_temp) <- gsub("X", "", colnames(df_trabajo_temp))

#limpieza de datos abandono
names(df_abandono) <- as.matrix(df_abandono[1, ])
df_abandono <- df_abandono[-c(1:2), ]
df_abandono[] <- lapply(df_abandono, function(x) type.convert(as.character(x)))

df_abandono <- df_abandono[-1]
df_abandono <- data.frame(lapply(df_abandono, function(x) gsub(",", ".", x, fixed = TRUE)))
df_abandono <- as.data.frame(sapply(df_abandono, as.numeric))

df_abandono$CCAA <- CCAA_sin_UE_sin_ord
df_abandono <- df_abandono  %>% select(CCAA, everything())
colnames (df_abandono) <- gsub("X", "", colnames(df_abandono))

#limpieza datos esperanza de vida
names(df_esperanza_vida) <- as.matrix(df_esperanza_vida[1, ])
df_esperanza_vida <- df_esperanza_vida[-c(1:2), ]
df_esperanza_vida[] <- lapply(df_esperanza_vida, function(x) type.convert(as.character(x)))

df_esperanza_vida$CCAA <- CCAA_sin_UE_sin_ord
df_esperanza_vida <- df_esperanza_vida  %>% select(CCAA, everything())
colnames (df_esperanza_vida) <- gsub("X", "", colnames(df_esperanza_vida))

#limpieza datos acceso 1

names(df_no_acceso_1) <- as.matrix(df_no_acceso_1[1, ])
df_no_acceso_1 <- df_no_acceso_1[-c(1:2), ]
df_no_acceso_1[] <- lapply(df_no_acceso_1, function(x) type.convert(as.character(x)))

df_no_acceso_1$CCAA <- CCAA_sin_UE_sin_ord
df_no_acceso_1 <- df_no_acceso_1  %>% select(CCAA, everything())
colnames (df_no_acceso_1) <- gsub("X", "", colnames(df_no_acceso_1))

#edcu38 limpieza datos
names(df_educ_38) <- as.matrix(df_educ_38[1, ])
df_educ_38 <- df_educ_38[-c(1:3), ]
df_educ_38[] <- lapply(df_educ_38, function(x) type.convert(as.character(x)))

df_educ_38$CCAA <- CCAA_sin_UE_sin_ord
df_educ_38 <- df_educ_38  %>% select(CCAA, everything())
colnames (df_educ_38) <- gsub("X", "", colnames(df_educ_38))

#limpieza datos ruido
names(df_ruidos) <- as.matrix(df_ruidos[1, ])
df_ruidos <- df_ruidos[-c(1,9), ]
df_ruidos[] <- lapply(df_ruidos, function(x) type.convert(as.character(x)))

df_ruidos <- df_ruidos[-1]
df_ruidos <- data.frame(lapply(df_ruidos, function(x) gsub(",", ".", x, fixed = TRUE)))
df_ruidos <- as.data.frame(sapply(df_ruidos, as.numeric))

df_ruidos$CCAA <- CCAA_2
df_ruidos <- df_ruidos %>% select(CCAA, everything())
colnames (df_ruidos) <- gsub("X", "", colnames(df_ruidos))

#limpieza datos delincuencia
names(df_del_ccaa) <- as.matrix(df_del_ccaa[1, ])
df_del_ccaa <- df_del_ccaa[-c(1,2), ]
df_del_ccaa[] <- lapply(df_del_ccaa, function(x) type.convert(as.character(x)))

df_del_ccaa <- df_del_ccaa[-1]
df_del_ccaa <- data.frame(lapply(df_del_ccaa, function(x) gsub(",", ".", x, fixed = TRUE)))
df_del_ccaa <- as.data.frame(sapply(df_del_ccaa, as.numeric))

df_del_ccaa$CCAA <- CCAA_sin_UE_sin_ord
df_del_ccaa <- df_del_ccaa %>% select(CCAA, everything())
colnames(df_del_ccaa) <- gsub("X", "", colnames(df_del_ccaa))
```
<br><br>

### 6.1.1 Índices de las condiciones materiales

En cuanto a las condicones materiales, vemos que destaca sobre todo el País Vasco, Navarra, Madrid y Cataluña. En las últimas posiciones, vemos a Ceuta, Melilla, Extremadura y Andalucia.  La Comunidad Valenciana se encuentra muy por debajo también de las regiones top y algo por encima de las más pobres.

<br>
```{r indice condiciones materiales , echo=FALSE, eval=TRUE}

#Renta media normalizado
#convertir 2020 a numeros
df_Renta_media$`2020` <- as.numeric(df_Renta_media$`2020`)
#Sacar valores normalizados
Renta_media_norm <- as.data.frame(lapply(df_Renta_media[14], min_max_norm_gran))
Renta_media_norm$CCAA <- CCAA_sin_UE
Renta_media_norm <- Renta_media_norm  %>% select(CCAA = "CCAA", everything())

#Renta mediana normalizado
df_Renta_mediana$`2020` <- as.numeric(df_Renta_mediana$`2020`)
#Sacar valores normalizados
Renta_mediana_norm <- as.data.frame(lapply(df_Renta_mediana[14], min_max_norm_gran))
Renta_mediana_norm$CCAA <- CCAA_sin_UE
Renta_mediana_norm <- Renta_mediana_norm  %>% select(CCAA = "CCAA", everything())

#Desigualdad normalizado
#cuanto mayor es, mayor es la desigualdad
#Sacar valores normalizados
Desigualdad_norm <- as.data.frame(lapply(df_Desigualdad[14], min_max_norm_peq))
Desigualdad_norm$CCAA <- CCAA_sin_UE
Desigualdad_norm <- Desigualdad_norm  %>% select(CCAA = "CCAA", everything())

#Riesgo de pobreza normalizado

#lo de sub es para cambiar de coma a punto, r lee decimales con puntos
df_Riesgo_pobreza$`2020` <- as.numeric(sub(",", ".", df_Riesgo_pobreza$`2020`, fixed = TRUE))
#Sacar valores normalizados
Riesgo_pobreza_norm <- as.data.frame(lapply(df_Riesgo_pobreza[14], min_max_norm_peq))
Riesgo_pobreza_norm$CCAA <- CCAA_sin_UE
Riesgo_pobreza_norm <- Riesgo_pobreza_norm  %>% select(CCAA = "CCAA", everything())

#unión de condiciones económicas------------
df_norm_cond_econ <- inner_join(Renta_media_norm, Renta_mediana_norm, by = "CCAA")
df_norm_cond_econ <- df_norm_cond_econ %>% rename(Renta_media = X2020.x, Renta_mediana = X2020.y)

df_norm_cond_econ_2 <- inner_join(Desigualdad_norm, Riesgo_pobreza_norm, by = "CCAA")
df_norm_cond_econ_2 <- df_norm_cond_econ_2 %>% rename(Desigualdad = X2020.x, Riesgo_pobreza = X2020.y)

#tabla con las condiciones económicas normalizadas de cada una de las CCAA
df_norm_cond_econ_suma <- inner_join(df_norm_cond_econ, df_norm_cond_econ_2, by = "CCAA")

#añadir columna con total de valores normalizados
df_norm_cond_econ_suma_no_CCAA <- df_norm_cond_econ_suma %>% select(!"CCAA")

#Sumamos todos los (4) subindicadores y creamos columna con el total
Suma_cond_econ_norm_ord <- df_norm_cond_econ_suma  %>% mutate(cond_econ_total = rowSums(df_norm_cond_econ_suma_no_CCAA)) %>% arrange(desc(cond_econ_total))
Suma_cond_econ_norm <- df_norm_cond_econ_suma  %>% mutate(cond_econ_total = rowSums(df_norm_cond_econ_suma_no_CCAA)) 

#Puntuación de condiciones económicas----------
Total_norm_cond_econ <- Suma_cond_econ_norm %>% select("CCAA", "cond_econ_total") 

Norm_cond_econ <- as.data.frame(lapply(Total_norm_cond_econ[2], min_max_norm_gran))
Norm_cond_econ$CCAA <- CCAA_sin_UE
Norm_cond_econ <- Norm_cond_econ  %>% select(CCAA = "CCAA", everything()) %>% arrange(desc(cond_econ_total))

#Gráfico de condicones materiales

#Renta media
CV_Renta_media <- Suma_cond_econ_norm_ord %>% select(CCAA, Renta_media) %>% filter(CCAA == "Comunidad_Valenciana")
g_renta_media <- Suma_cond_econ_norm_ord %>% select(CCAA, Renta_media) %>% ggplot(aes(x = reorder(CCAA, Renta_media), y = Renta_media)) + 
  geom_bar(position = "dodge",
           stat = "identity",
           fill = "dark green") +
  labs( y = "Valores del Índice" ,
        title = "Renta media") +
  coord_flip() +
  #geom_hline(yintercept = quartiles, colour = "red") +
  geom_bar(data = CV_Renta_media,
           position = "dodge",
           stat = "identity",
           fill = "purple") +
  theme_wsj()
g_renta_media

#Renta mediana
CV_Renta_mediana <- Suma_cond_econ_norm_ord %>% select(CCAA, Renta_mediana) %>% filter(CCAA == "Comunidad_Valenciana")
g_renta_mediana <- Suma_cond_econ_norm_ord %>% select(CCAA, Renta_mediana) %>% ggplot(aes(x = reorder(CCAA, Renta_mediana), y = Renta_mediana)) + 
  geom_bar(position = "dodge",
           stat = "identity",
           fill = "dark green") +
  labs( y = "Valores del Índice" ,
        title = "Renta mediana") +
  coord_flip() +
  #geom_hline(yintercept = quartiles, colour = "red") +
  geom_bar(data = CV_Renta_mediana,
           position = "dodge",
           stat = "identity",
           fill = "purple") +
  theme_wsj()
g_renta_mediana

#Desigualdad
CV_Desigualdad <- Suma_cond_econ_norm_ord %>% select(CCAA, Desigualdad) %>% filter(CCAA == "Comunidad_Valenciana")
g_Desigualdad <- Suma_cond_econ_norm_ord %>% select(CCAA, Desigualdad) %>% ggplot(aes(x = reorder(CCAA, Desigualdad), y = Desigualdad)) + 
  geom_bar(position = "dodge",
           stat = "identity",
           fill = "dark green") +
  labs( y = "Valores del Índice" ,
        title = "Desigualdad") +
  coord_flip() +
  #geom_hline(yintercept = quartiles, colour = "red") +
  geom_bar(data = CV_Desigualdad,
           position = "dodge",
           stat = "identity",
           fill = "purple") +
  theme_wsj()
g_Desigualdad

#Riesgo Pobreza
CV_Riesgo_pobreza <- Suma_cond_econ_norm_ord %>% select(CCAA, Riesgo_pobreza) %>% filter(CCAA == "Comunidad_Valenciana")
g_Riesgo_pobreza <- Suma_cond_econ_norm_ord %>% select(CCAA, Riesgo_pobreza) %>% ggplot(aes(x = reorder(CCAA, Riesgo_pobreza), y = Riesgo_pobreza)) + 
  geom_bar(position = "dodge",
           stat = "identity",
           fill = "dark green") +
  labs( y = "Valores del Índice" ,
        title = "Riesgo Pobreza") +
  coord_flip() +
  #geom_hline(yintercept = quartiles, colour = "red") +
  geom_bar(data = CV_Riesgo_pobreza,
           position = "dodge",
           stat = "identity",
           fill = "purple") +
  theme_wsj()
g_Riesgo_pobreza

```
<br> <br>

### 6.1.2 Índices del trabajo

Podemos observar en el caso del trabajo, que la Comunidad Valenciana se posiciona en la parte inferior baja de la tabla, pero sí es verdad que en satisfacción del trabajo y en la tasa de empleo se encuentra más arriba que la posición en la que se encuentra normalmente. En términos generales, vemos como en este caso la hegemonía del País Vasco no se mantiene, sino que es adelantado por varias comunidades en varios de los indicadores. Algo que podemos resaltar de este ranking, es la posición de las CCAA en cuanto a la satisfacción de trabajo sobre todo la primera posición de Melilla. De hecho, es el único indicador en el cual lidera el ranking y nos hace pensar si realmente la renta es un buen indicador del nivel de vida. 

<br>
```{r indice trabajo , echo=FALSE, eval=TRUE}

#Tasa empleo normalizado

#Sacar valores normalizados
tasa_empleo_norm <- as.data.frame(lapply(df_tasa_empleo[16], min_max_norm_gran))
tasa_empleo_norm$CCAA <- CCAA_sin_UE_sin_ord
tasa_empleo_norm <- tasa_empleo_norm  %>% select(CCAA = "CCAA", everything())

#Tasa paro normalizado

tasa_paro_norm <- as.data.frame(lapply(df_tasa_paro[16], min_max_norm_peq))
tasa_paro_norm$CCAA <- CCAA_sin_UE_sin_ord
tasa_paro_norm <- tasa_paro_norm  %>% select(CCAA = "CCAA", everything())

#satisfacción trabajo normalizado


satis_trab_norm <- as.data.frame(lapply(df_satis_trab[6], min_max_norm_gran))
satis_trab_norm$CCAA <- CCAA_sin_UE_sin_ord
satis_trab_norm <- satis_trab_norm  %>% select(CCAA = "CCAA", everything())

#trabajo temporal normalizado


trabajo_temp_norm <- as.data.frame(lapply(df_trabajo_temp[16], min_max_norm_peq))
trabajo_temp_norm$CCAA <- CCAA_sin_UE_sin_ord
trabajo_temp_norm <- trabajo_temp_norm  %>% select(CCAA = "CCAA", everything())

#unión de TRABAJO-------------
df_norm_trabajo <- inner_join(tasa_empleo_norm, tasa_paro_norm, by = "CCAA")
df_norm_trabajo <- df_norm_trabajo %>% rename(tasa_empleo = X2020.x, tasa_paro = X2020.y)

df_norm_trabajo_2 <- inner_join(satis_trab_norm, trabajo_temp_norm, by = "CCAA")
df_norm_trabajo_2 <- df_norm_trabajo_2 %>% rename(satis_trab = Satisfaccion.media, trabajo_temp = X2020)

#tabla con las condiciones económicas normalizadas de cada una de las CCAA
df_norm_trabajo_suma <- inner_join(df_norm_trabajo, df_norm_trabajo_2, by = "CCAA")

#añadir columna con total de valores normalizados
df_norm_trabajo_suma_no_CCAA <- df_norm_trabajo_suma %>% select(!"CCAA")

#ordenado
Suma_trabajo_norm_ord <- df_norm_trabajo_suma  %>% mutate(trabajo_total = rowSums(df_norm_trabajo_suma_no_CCAA)) %>% arrange(desc(trabajo_total))
#no ordenado
Suma_trabajo_norm <- df_norm_trabajo_suma  %>% mutate(trabajo_total = rowSums(df_norm_trabajo_suma_no_CCAA)) 

#Puntuación de trabajo-----
Total_norm_trabajo <- Suma_trabajo_norm %>% select("CCAA", "trabajo_total") 

Norm_trabajo <- as.data.frame(lapply(Total_norm_trabajo[2], min_max_norm_gran))
Norm_trabajo$CCAA <- CCAA_sin_UE_sin_ord
Norm_trabajo <- Norm_trabajo  %>% select(CCAA = "CCAA", everything()) %>% arrange(desc(trabajo_total))

#tasa empleo
CV_tasa_empleo <- Suma_trabajo_norm_ord %>% select(CCAA, tasa_empleo) %>% filter(CCAA == "Comunidad_Valenciana")
g_tasa_empleo <- Suma_trabajo_norm_ord %>% select(CCAA, tasa_empleo) %>% ggplot(aes(x = reorder(CCAA, tasa_empleo), y = tasa_empleo)) + 
  geom_bar(position = "dodge",
           stat = "identity",
           fill = "red") +
  labs( y = "Valores del Índice" ,
        title = "Tasa de empleo") +
  coord_flip() +
  #geom_hline(yintercept = quartiles, colour = "red") +
  geom_bar(data = CV_tasa_empleo,
           position = "dodge",
           stat = "identity",
           fill = "yellow") +
  theme_wsj()
g_tasa_empleo

#tasa paro
CV_tasa_paro <- Suma_trabajo_norm_ord %>% select(CCAA, tasa_paro) %>% filter(CCAA == "Comunidad_Valenciana")
g_tasa_paro <- Suma_trabajo_norm_ord %>% select(CCAA, tasa_paro) %>% ggplot(aes(x = reorder(CCAA, tasa_paro), y = tasa_paro)) + 
  geom_bar(position = "dodge",
           stat = "identity",
           fill = "red") +
  labs( y = "Valores del Índice" ,
        title = "Tasa de paro") +
  coord_flip() +
  #geom_hline(yintercept = quartiles, colour = "red") +
  geom_bar(data = CV_tasa_paro,
           position = "dodge",
           stat = "identity",
           fill = "yellow") +
  theme_wsj()
g_tasa_paro

#satisfaccion tabajo
CV_satis_trab <- Suma_trabajo_norm_ord %>% select(CCAA, satis_trab) %>% filter(CCAA == "Comunidad_Valenciana")
g_satis_trab <- Suma_trabajo_norm_ord %>% select(CCAA, satis_trab) %>% ggplot(aes(x = reorder(CCAA, satis_trab), y = satis_trab)) + 
  geom_bar(position = "dodge",
           stat = "identity",
           fill = "red") +
  labs( y = "Valores del Índice" ,
        title = "satisfacción del trabajo") +
  coord_flip() +
  #geom_hline(yintercept = quartiles, colour = "red") +
  geom_bar(data = CV_satis_trab,
           position = "dodge",
           stat = "identity",
           fill = "yellow") +
  theme_wsj()
g_satis_trab

#trabajo temporal
CV_trabajo_temp <- Suma_trabajo_norm_ord %>% select(CCAA, trabajo_temp) %>% filter(CCAA == "Comunidad_Valenciana")
g_trabajo_temp <- Suma_trabajo_norm_ord %>% select(CCAA, trabajo_temp) %>% ggplot(aes(x = reorder(CCAA, trabajo_temp), y = trabajo_temp)) + 
  geom_bar(position = "dodge",
           stat = "identity",
           fill = "red") +
  labs( y = "Valores del Índice" ,
        title = "Trabajo temporal") +
  coord_flip() +
  #geom_hline(yintercept = quartiles, colour = "red") +
  geom_bar(data = CV_trabajo_temp,
           position = "dodge",
           stat = "identity",
           fill = "yellow") +
  theme_wsj()
g_trabajo_temp

```
<br><br>

## 6.1.3 Índices de la educación y la salud

En temas de salud y educación, destacan las regiones de País vasco, Cantabria, Madrid, Asturias y Galicia mientras que a la cola están Ceuta, Melilla, Andalucía, Canarias y Castilla la Mancha. La Comunidad Valenciana está justo debajo de la mitad como en muchos otros indicadores.

<br>
```{r indice educacion y salud , echo=FALSE, eval=TRUE}


#valores normalizados

#tasa abandono normalizado
#Sacar valores normalizados
abandono_norm <- as.data.frame(lapply(df_abandono[18], min_max_norm_peq))
abandono_norm$CCAA <- CCAA_sin_UE_sin_ord
abandono_norm <- abandono_norm  %>% select(CCAA = "CCAA", everything())

#esperanza vida normalizado
df_esperanza_vida$`2020` <- as.numeric(sub(",", ".", df_esperanza_vida$`2020*`, fixed = TRUE))
df_esperanza_vida <- df_esperanza_vida[-c(18)]
#Sacar valores normalizados
esperanza_vida_norm <- as.data.frame(lapply(df_esperanza_vida[18], min_max_norm_gran))
esperanza_vida_norm$CCAA <- CCAA_sin_UE_sin_ord
esperanza_vida_norm <- esperanza_vida_norm  %>% select(CCAA = "CCAA", everything())

#acceso normalizado
df_no_acceso_1$`2020` <- as.numeric(sub(",", ".", df_no_acceso_1$`2020`, fixed = TRUE))
#Sacar valores normalizados
no_acceso_1_norm <- as.data.frame(lapply(df_no_acceso_1[18], min_max_norm_peq))
no_acceso_1_norm$CCAA <- CCAA_sin_UE_sin_ord
no_acceso_1_norm <- no_acceso_1_norm  %>% select(CCAA = "CCAA", everything())

#educ_38 normalizado

df_educ_38$`2020` <- as.numeric(sub(",", ".", df_educ_38$`2020`, fixed = TRUE))
#Sacar valores normalizados
educ_38_norm <- as.data.frame(lapply(df_educ_38[18], min_max_norm_gran))
educ_38_norm$CCAA <- CCAA_sin_UE_sin_ord
educ_38_norm <- educ_38_norm  %>% select(CCAA = "CCAA", everything())


#unión de EDUCACIÓN Y SALUD-------------
df_norm_educ_salud <- inner_join(no_acceso_1_norm, esperanza_vida_norm , by = "CCAA")
df_norm_educ_salud <- df_norm_educ_salud %>% rename(no_acceso_1 = X2020.x, esperanza_vida = X2020.y)

df_norm_educ_salud_2 <- inner_join(abandono_norm, educ_38_norm, by = "CCAA")
df_norm_educ_salud_2 <- df_norm_educ_salud_2 %>% rename(abandono = X2020.x, educ_38 = X2020.y)

#tabla con las condiciones económicas normalizadas de cada una de las CCAA
df_norm_educ_salud_suma <- inner_join(df_norm_educ_salud, df_norm_educ_salud_2, by = "CCAA")

#añadir columna con total de valores normalizados
df_norm_educ_salud_suma_no_CCAA <- df_norm_educ_salud_suma %>% select(!"CCAA")

#ordenado
Suma_educ_salud_norm_ord <- df_norm_educ_salud_suma  %>% mutate(Educ_salud_Total = rowSums(df_norm_educ_salud_suma_no_CCAA)) %>% arrange(desc(Educ_salud_Total))
#no ordenado
Suma_educ_salud_norm <- df_norm_educ_salud_suma  %>% mutate(Educ_salud_Total = rowSums(df_norm_educ_salud_suma_no_CCAA)) 

#Puntuación de educ_salud, faltaría hacer lo mismo para las otras cuatro condciones y luego asignar un porcentaje a cada uno si es posible.------------
Total_norm_educ_salud <- Suma_educ_salud_norm %>% select("CCAA", "Educ_salud_Total") 

Norm_educ_salud <- as.data.frame(lapply(Total_norm_educ_salud[2], min_max_norm_gran))
Norm_educ_salud$CCAA <- CCAA_sin_UE_sin_ord
Norm_educ_salud <- Norm_educ_salud  %>% select(CCAA = "CCAA", everything()) %>% arrange(desc(Educ_salud_Total))

#no acceso_1
CV_no_acceso_1 <- Suma_educ_salud_norm_ord %>% select(CCAA, no_acceso_1) %>% filter(CCAA == "Comunidad_Valenciana")
g_no_acceso_1 <- Suma_educ_salud_norm_ord %>% select(CCAA, no_acceso_1) %>% ggplot(aes(x = reorder(CCAA, no_acceso_1), y = no_acceso_1)) + 
  geom_bar(position = "dodge",
           stat = "identity",
           fill = "brown") +
  labs( y = "Valores del Índice" ,
        title = "Problemas de acceso sanitario ",
        subtitle = "Por las razones del grupo 1") +
  coord_flip() +
  #geom_hline(yintercept = quartiles, colour = "red") +
  geom_bar(data = CV_no_acceso_1,
           position = "dodge",
           stat = "identity",
           fill = "pink") +
  theme_wsj()
g_no_acceso_1

#esperanza de vida
CV_esperanza_vida <- Suma_educ_salud_norm_ord %>% select(CCAA, esperanza_vida) %>% filter(CCAA == "Comunidad_Valenciana")
g_esperanza_vida <- Suma_educ_salud_norm_ord %>% select(CCAA, esperanza_vida) %>% ggplot(aes(x = reorder(CCAA, esperanza_vida), y = esperanza_vida)) + 
  geom_bar(position = "dodge",
           stat = "identity",
           fill = "brown") +
  labs( y = "Valores del Índice" ,
        title = "Esperanza de Vida") +
  coord_flip() +
  #geom_hline(yintercept = quartiles, colour = "red") +
  geom_bar(data = CV_esperanza_vida,
           position = "dodge",
           stat = "identity",
           fill = "pink") +
  theme_wsj()
g_esperanza_vida

#tasa abandono
CV_abandono <- Suma_educ_salud_norm_ord %>% select(CCAA, abandono) %>% filter(CCAA == "Comunidad_Valenciana")
g_abandono <- Suma_educ_salud_norm_ord %>% select(CCAA, abandono) %>% ggplot(aes(x = reorder(CCAA, abandono), y = abandono)) + 
  geom_bar(position = "dodge",
           stat = "identity",
           fill = "brown") +
  labs( y = "Valores del Índice" ,
        title = "Tasa de abandono") +
  coord_flip() +
  #geom_hline(yintercept = quartiles, colour = "red") +
  geom_bar(data = CV_abandono,
           position = "dodge",
           stat = "identity",
           fill = "pink") +
  theme_wsj()
g_abandono

#nivel de educación
CV_educ_38 <- Suma_educ_salud_norm_ord %>% select(CCAA, educ_38) %>% filter(CCAA == "Comunidad_Valenciana")
g_educ_38 <- Suma_educ_salud_norm_ord %>% select(CCAA, educ_38) %>% ggplot(aes(x = reorder(CCAA, educ_38), y = educ_38)) + 
  geom_bar(position = "dodge",
           stat = "identity",
           fill = "brown") +
  labs( y = "Valores del Índice" ,
        title = "Nivel de educ. 3-8") +
  coord_flip() +
  #geom_hline(yintercept = quartiles, colour = "red") +
  geom_bar(data = CV_educ_38,
           position = "dodge",
           stat = "identity",
           fill = "pink") +
  theme_wsj()
g_educ_38


```
<br> <br>

## 6.1.4 Índices de otros indicadores

En "otros indicadores", destcan regiones que no suelen estar en la cima como por ejemplo Cantabria, Extremadura y Castilla y León y a su vez, la Comunidad Valenciana está por encima del 50% justo por delante de Cataluña y justo por debajo del País vasco.

<br>
```{r indice otros indicadores , echo=FALSE, eval=TRUE}

#ruido normalizado
df_ruidos_norm <- as.data.frame(lapply(df_ruidos[18], min_max_norm_peq))
df_ruidos_norm$CCAA <- CCAA_2
df_ruidos_norm <- df_ruidos_norm %>% select(CCAA = "CCAA", everything())

#delincuencia
df_del_ccaa_norm <- as.data.frame(lapply(df_del_ccaa[18], min_max_norm_peq))
df_del_ccaa_norm$CCAA <- CCAA_sin_UE_sin_ord
df_del_ccaa_norm <- df_del_ccaa_norm %>% select(CCAA = "CCAA", everything())

#unión efectos ambientales
df_ef_amb_norm <- inner_join(df_ruidos_norm, df_del_ccaa_norm, by = "CCAA")
df_ef_amb_norm <- df_ef_amb_norm %>% rename(ruidos = X2020.x, delincuencia = X2020.y)

df_ef_amb_norm_suma_no_CCAA <- df_ef_amb_norm %>% select(!"CCAA")

#ordenado
Suma_ef_amb_norm_suma <- df_ef_amb_norm  %>% mutate(Ef_amb_total = rowSums(df_ef_amb_norm_suma_no_CCAA)) %>% arrange(desc(Ef_amb_total))
#no ordenado
Suma_ef_amb_norm_suma_ord <- df_ef_amb_norm  %>% mutate(Ef_amb_total = rowSums(df_ef_amb_norm_suma_no_CCAA))

#Puntuación de efectos ambientales, faltaría hacer lo mismo para las otras cuatro condciones y luego asignar un porcentaje a cada uno si es posible.------------
Total_norm_ef_amb <- Suma_ef_amb_norm_suma %>% select("CCAA", "Ef_amb_total") 

Norm_ef_amb <- as.data.frame(lapply(Total_norm_ef_amb[2], min_max_norm_gran))

Norm_ef_amb$CCAA <- CCAA_3
Norm_ef_amb <- Norm_ef_amb %>% select(CCAA = "CCAA", everything()) %>% arrange(desc(Ef_amb_total))

#Ruido
CV_Ruido <- Suma_ef_amb_norm_suma_ord %>% select(CCAA, ruidos) %>% filter(CCAA == "Comunidad_Valenciana")
g_ruido <- Suma_ef_amb_norm_suma_ord %>% select(CCAA, ruidos) %>% ggplot(aes(x = reorder(CCAA, ruidos), y = ruidos)) + 
  geom_bar(position = "dodge",
           stat = "identity",
           fill = "blue") +
  labs( y = "Valores del Índice" ,
        title = "Problemas de ruido") +
  coord_flip() +
  #geom_hline(yintercept = quartiles, colour = "red") +
  geom_bar(data = CV_Ruido,
           position = "dodge",
           stat = "identity",
           fill = "red") +
  theme_wsj()
g_ruido

#Delincuencia
CV_delincuencia <- Suma_ef_amb_norm_suma_ord %>% select(CCAA, delincuencia) %>% filter(CCAA == "Comunidad_Valenciana")
g_delincuencia <- Suma_ef_amb_norm_suma_ord %>% select(CCAA, delincuencia) %>% ggplot(aes(x = reorder(CCAA, delincuencia), y = delincuencia)) + 
  geom_bar(position = "dodge",
           stat = "identity",
           fill = "blue") +
  labs( y = "Valores del Índice" ,
        title = "Percepción de delincuencia") +
  coord_flip() +
  #geom_hline(yintercept = quartiles, colour = "red") +
  geom_bar(data = CV_delincuencia,
           position = "dodge",
           stat = "identity",
           fill = "red") +
  theme_wsj()
g_delincuencia


```
<br><br>


## 6.2 Índice de las cuatro categorías

<br>

```{r indice de las cuatro categorias conjunto , echo=FALSE, eval=TRUE}
#Gráfico índice condicionesmateriales-----------

CV_Norm_cond_econ <- Norm_cond_econ %>% filter(CCAA == "Comunidad_Valenciana")

p_cond_mat <- Norm_cond_econ %>% ggplot(aes(x = reorder(CCAA, cond_econ_total), y = cond_econ_total)) + 
  geom_bar(position = "dodge",
    stat = "identity",
    fill = "steelblue") +
  labs( y = "Valores del Índice" ,
       title = "Las condiciones materiales",
       #subtitle = "Destacando la Comunidad Valenciana",
       caption = "Elaboración propia") +
  coord_flip() +
  #geom_hline(yintercept = quartiles, colour = "red") +
  theme(axis.line = element_line(colour = 'black', size = 1)) +
  geom_bar(data = CV_Norm_cond_econ,
           position = "dodge",
           stat = "identity",
           fill = " dark orange") +
  theme_wsj()

p_cond_mat

#Gráfico índice trabajo---------
CV_Norm_trabajo <- Norm_trabajo %>% filter(CCAA == "Comunidad_Valenciana")

p_trabajo <- Norm_trabajo %>% ggplot(aes(x = reorder(CCAA, trabajo_total), y = trabajo_total)) + 
  geom_bar(position = "dodge",
           stat = "identity",
           fill = "steelblue") +
  labs( y = "Valores del Índice" ,
        title = "El trabajo",
        #subtitle = "Destacando la Comunidad Valenciana",
        caption = "Elaboración propia") +
  coord_flip() +
  #geom_hline(yintercept = quartiles, colour = "red") +
  theme(axis.line = element_line(colour = 'black', size = 1)) +
  geom_bar(data = CV_Norm_trabajo,
           position = "dodge",
           stat = "identity",
           fill = " dark orange") +
  theme_wsj()
p_trabajo

#Gráfico educ salud----------
CV_Norm_educ_salud <- Norm_educ_salud %>% filter(CCAA == "Comunidad_Valenciana")

p_educ_salud <- Norm_educ_salud  %>% ggplot(aes(x = reorder(CCAA, Educ_salud_Total), y = Educ_salud_Total)) + 
  geom_bar(position = "dodge",
           stat = "identity",
           fill = "steelblue") +
  labs( y = "Valores del Índice" ,
        title = "Educación y la salud",
        #subtitle = "Destacando la Comunidad Valenciana",
        caption = "Elaboración propia") +
  coord_flip() +
  #geom_hline(yintercept = quartiles, colour = "red") +
  theme(axis.line = element_line(colour = 'black', size = 1)) +
  geom_bar(data = CV_Norm_educ_salud,
           position = "dodge",
           stat = "identity",
           fill = " dark orange") +
  theme_wsj()

p_educ_salud

#Gráfico otros indicadores---------
CV_Norm_ef_amb <- Norm_ef_amb %>% filter(CCAA == "Comunidad_Valenciana")

p_otros_ind <- Norm_ef_amb  %>% ggplot(aes(x = reorder(CCAA, Ef_amb_total), y = Ef_amb_total)) + 
  geom_bar(position = "dodge",
           stat = "identity",
           fill = "steelblue") +
  labs( y = "Valores del Índice" ,
        title = "Otros indicadores",
        #subtitle = "Destacando la Comunidad Valenciana",
        caption = "Elaboración propia") +
  coord_flip() +
  #geom_hline(yintercept = quartiles, colour = "red") +
  theme(axis.line = element_line(colour = 'black', size = 1)) +
  geom_bar(data = CV_Norm_ef_amb,
           position = "dodge",
           stat = "identity",
           fill = " dark orange") +
  theme_wsj()
p_otros_ind




```

<br><br>

## 6.3 Índice final

En conclusión, vemos que la Comunidad Valenciana suele estar a niveles medios en comparación con el resto de las CCAA. Existen indicadores en el cual está por encima de la media de España pero otros en el cual su ranking es muy inferior. Además, observamos una clara tendencia en donde las zonas industriales como País Vasco Navrra y Madrid lideran el ranking, mientras que las zonas tradionalmente mñas subdesarrollados como Ceuta, Melilla, Andalucía, Canarias y Murcia están muy alejados del resto de España. A todo esto, habría que actualizar los datos de este año con los efectos econñomicos negativos provcados por la crisis sanitaria d ela COVID-19 y analizar el efecto, si ha sido homogéneo o heterogéneo entre las Comunidades Autónomas de España.
<br>
```{r ranking final , echo=FALSE, eval=TRUE}

#Crear Ranking Final

df_cond_econ_educ_salud <- inner_join(Norm_cond_econ, Norm_educ_salud, by = "CCAA")
df_ef_amb_trabajo <- inner_join(Norm_ef_amb, Norm_trabajo, by = "CCAA")

df_ranking_final <- inner_join(df_cond_econ_educ_salud, df_ef_amb_trabajo, by = "CCAA")

df_ranking_final_sin_CCAA <- df_ranking_final %>% select(!"CCAA")

#ordenado
Suma_ranking_final_ord <- df_ranking_final %>% mutate(ranking_final_total = rowSums(df_ranking_final_sin_CCAA)) %>% arrange(desc(ranking_final_total))
#no ordenado
Suma_ranking_final <- df_ranking_final  %>% mutate(ranking_final_total = rowSums(df_ranking_final_sin_CCAA)) 

#Puntuación de ranking final
Total_norm_ranking_final <- Suma_ranking_final %>% select("CCAA", "ranking_final_total") 

Norm_ranking_final <- as.data.frame(lapply(Total_norm_ranking_final[2], min_max_norm_gran))
Norm_ranking_final$CCAA <- CCAA_rank_final
Norm_ranking_final <- Norm_ranking_final  %>% select(CCAA = "CCAA", everything()) %>% arrange(desc(ranking_final_total))

#Gráfico con Ranking Final-------------
CV_ranking_final <- Norm_ranking_final %>% filter(CCAA == "Comunidad_Valenciana")

p_rank_final <- Norm_ranking_final  %>% ggplot(aes(x = reorder(CCAA, ranking_final_total), y = ranking_final_total)) + 
  geom_bar(position = "dodge",
           stat = "identity",
           fill = "green") +
  labs( y = "Valores del Índice" ,
        title = "Índice de Buena Vida",
        caption = "Elaboración propia") +
  coord_flip() +
  #geom_hline(yintercept = quartiles, colour = "red") +
  theme(axis.line = element_line(colour = 'black', size = 1)) +
  geom_bar(data = CV_ranking_final,
           position = "dodge",
           stat = "identity",
           fill = " dark orange") +
  theme_wsj()

p_rank_final

```
<br>